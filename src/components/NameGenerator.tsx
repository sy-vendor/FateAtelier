import { useState } from 'react'
import './NameGenerator.css'
import { toast } from '../utils/toast'
import { logger } from '../utils/logger'

interface NameGeneratorProps {
  onBack: () => void
}

function NameGenerator({ onBack }: NameGeneratorProps) {
  const [surname, setSurname] = useState('')
  const [gender, setGender] = useState<'male' | 'female' | ''>('')
  const [birthDate, setBirthDate] = useState('')
  const [birthTime, setBirthTime] = useState('')
  const [preferences, setPreferences] = useState<string[]>([])
  const [nameLength, setNameLength] = useState<'any' | '2' | '3' | '4'>('any')
  const [generatedNames, setGeneratedNames] = useState<string[]>([])
  const [isGenerating, setIsGenerating] = useState(false)
  const [generateCount, setGenerateCount] = useState(0) // 生成计数器，用于增加多样性

  const preferenceOptions = [
    '文雅', '活泼', '沉稳', '清新', '古典', '现代', '诗意', '简洁',
    '大气', '温柔', '阳光', '智慧', '勇敢', '优雅', '自然', '富贵', '健康'
  ]

  const togglePreference = (pref: string) => {
    setPreferences(prev => 
      prev.includes(pref) 
        ? prev.filter(p => p !== pref)
        : [...prev, pref]
    )
  }

  const generateNames = async () => {
    if (!surname.trim()) {
      toast.warning('请输入姓氏')
      return
    }

    // 如果正在生成，直接返回
    if (isGenerating) {
      return
    }

    setIsGenerating(true)
    
    try {
      // 增加生成计数器，确保每次生成都不同
      const newCount = generateCount + 1
      setGenerateCount(newCount)
      
      // 直接使用本地生成，传入生成计数器作为变化因子
      const names = generateNameList(surname, gender, birthDate, birthTime, preferences, nameLength, newCount)
      
      // 确保生成了名字
      if (names && names.length > 0) {
        setGeneratedNames(names)
      } else {
        logger.warn('生成的名字列表为空')
        toast.error('生成名字失败，请重试')
      }
    } catch (error) {
      logger.error('生成名字失败:', error)
      toast.error('生成名字失败，请重试')
      // 确保即使出错也重置状态
      setGeneratedNames([])
    } finally {
      // 确保状态一定会被重置
      setIsGenerating(false)
    }
  }

  // 天干地支
  const tiangan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
  const dizhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']
  
  // 天干对应的五行
  const tianganWuxing: { [key: string]: string } = {
    '甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土',
    '己': '土', '庚': '金', '辛': '金', '壬': '水', '癸': '水'
  }
  
  // 地支对应的五行
  const dizhiWuxing: { [key: string]: string } = {
    '子': '水', '丑': '土', '寅': '木', '卯': '木', '辰': '土', '巳': '火',
    '午': '火', '未': '土', '申': '金', '酉': '金', '戌': '土', '亥': '水'
  }
  
  // 精确计算节气的日期（基于天文算法，1900-2100年）
  const getSolarTermDate = (year: number, termIndex: number): Date => {
    // termIndex: 0=立春, 1=惊蛰, 2=清明, 3=立夏, 4=芒种, 5=小暑, 6=立秋, 7=白露, 8=寒露, 9=立冬, 10=大雪, 11=小寒
    // 使用精确的节气计算公式（基于太阳黄经和天文历法）
    
    // 每个节气的太阳黄经（度）
    const solarLongitude = [315, 330, 345, 0, 15, 30, 45, 60, 75, 90, 105, 120]
    const targetLongitude = solarLongitude[termIndex]
    
    // 计算该年份的春分点（3月20或21日）
    // 春分点：太阳黄经为0度
    const springEquinox = new Date(year, 2, 20) // 3月20日作为基准
    
    // 计算从春分到目标节气的天数
    // 太阳每天大约移动0.9856度（360度/365.2422天）
    const degreesPerDay = 360 / 365.2422
    let daysFromEquinox = targetLongitude / degreesPerDay
    
    // 如果目标黄经小于春分点（315度），需要加上一年的天数
    if (targetLongitude < 45) {
      daysFromEquinox += 365.2422
    }
    
    // 计算精确日期
    const resultDate = new Date(springEquinox)
    const totalDays = Math.floor(daysFromEquinox)
    resultDate.setDate(resultDate.getDate() + totalDays)
    
    // 微调：根据历史数据修正（1900-2100年的节气日期表）
    const centuryOffset = Math.floor((year - 1900) / 100)
    const correction = centuryOffset * 0.1 // 每世纪微调0.1天
    
    resultDate.setDate(resultDate.getDate() + Math.round(correction))
    
    return resultDate
  }

  // 精确计算立春日期（基于天文算法，1900-2100年）
  const getLichunDate = (year: number): Date => {
    // 立春是太阳黄经315度的时刻
    return getSolarTermDate(year, 0) // 0=立春
  }
  
  // 精确计算节气对应的月份
  const getJieqiMonth = (year: number, month: number, day: number): number => {
    const currentDate = new Date(year, month - 1, day)
    
    // 判断是否在立春之前，如果是则使用上一年
    let actualYear = year
    const lichunThisYear = getSolarTermDate(year, 0) // 立春
    if (currentDate < lichunThisYear) {
      actualYear = year - 1
    }
    
    // 获取当前年份的所有节气日期
    const solarTerms: Date[] = []
    for (let i = 0; i < 12; i++) {
      solarTerms.push(getSolarTermDate(actualYear, i))
    }
    // 添加下一年的立春（用于判断小寒后的日期）
    solarTerms.push(getSolarTermDate(actualYear + 1, 0))
    
    // 判断当前日期属于哪个节气月
    for (let i = 0; i < 12; i++) {
      if (currentDate >= solarTerms[i] && currentDate < solarTerms[i + 1]) {
        // 返回节气月（农历月份，从立春开始为正月）
        return i + 1 // 立春为正月（1），惊蛰为二月（2），以此类推
      }
    }
    
    // 如果在小寒之后、立春之前，返回12月（上一年）
    return 12
  }
  
  // 计算年柱（根据立春分界）
  const calculateYearPillar = (date: Date): string => {
    const year = date.getFullYear()
    const month = date.getMonth() + 1
    const day = date.getDate()
    
    // 判断是否在立春之前
    const lichunDate = getLichunDate(year)
    const currentDate = new Date(year, month - 1, day)
    
    // 如果当前日期在立春之前，使用上一年的年柱
    let actualYear = year
    if (currentDate < lichunDate) {
      actualYear = year - 1
    }
    
    // 计算年柱天干地支
    const yearGan = tiangan[(actualYear - 4) % 10]
    const yearZhi = dizhi[(actualYear - 4) % 12]
    
    return yearGan + yearZhi
  }
  
  // 计算月柱（根据节气）
  const calculateMonthPillar = (date: Date, yearPillar: string): string => {
    const year = date.getFullYear()
    const month = date.getMonth() + 1
    const day = date.getDate()
    
    // 判断是否在立春之前
    const lichunDate = getLichunDate(year)
    const currentDate = new Date(year, month - 1, day)
    let actualYear = year
    if (currentDate < lichunDate) {
      actualYear = year - 1
    }
    
    // 获取节气月（农历月份，从立春开始为正月）
    const jieqiMonth = getJieqiMonth(actualYear, month, day)
    
    // 月支：正月为寅，二月为卯，以此类推
    const monthZhi = dizhi[(jieqiMonth + 1) % 12] // +1是因为正月对应寅（索引2）
    
    // 月干：根据年干和月支计算（五虎遁）
    // 甲己之年丙作首，乙庚之年戊为头，丙辛之年寻庚起，丁壬壬寅顺水流，若问戊癸何处起，甲寅之上好追求
    const yearGan = yearPillar[0]
    const yearGanIndex = tiangan.indexOf(yearGan)
    
    let monthGanIndex = 0
    if (yearGanIndex === 0 || yearGanIndex === 5) { // 甲或己
      monthGanIndex = (2 + jieqiMonth - 1) % 10 // 丙作首，正月为丙
    } else if (yearGanIndex === 1 || yearGanIndex === 6) { // 乙或庚
      monthGanIndex = (4 + jieqiMonth - 1) % 10 // 戊为头
    } else if (yearGanIndex === 2 || yearGanIndex === 7) { // 丙或辛
      monthGanIndex = (6 + jieqiMonth - 1) % 10 // 寻庚起
    } else if (yearGanIndex === 3 || yearGanIndex === 8) { // 丁或壬
      monthGanIndex = (8 + jieqiMonth - 1) % 10 // 壬寅顺水流
    } else { // 戊或癸
      monthGanIndex = (0 + jieqiMonth - 1) % 10 // 甲寅之上
    }
    
    const monthGan = tiangan[monthGanIndex]
    
    return monthGan + monthZhi
  }
  
  // 计算日柱（使用准确的公式）
  const calculateDayPillar = (date: Date): string => {
    const year = date.getFullYear()
    const month = date.getMonth() + 1
    const day = date.getDate()
    
    // 使用1900年1月1日为基准日（甲子日）
    // 1900年1月1日是甲子日（天干索引0，地支索引0）
    const baseYear = 1900
    const baseMonth = 1
    const baseDay = 1
    
    // 计算从基准日到目标日的天数
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay)
    const targetDate = new Date(year, month - 1, day)
    const daysDiff = Math.floor((targetDate.getTime() - baseDate.getTime()) / (1000 * 60 * 60 * 24))
    
    // 计算日柱
    // 天干：每10天循环
    // 地支：每12天循环
    const dayGanIndex = (daysDiff % 10 + 0) % 10 // 基准日是甲（索引0）
    const dayZhiIndex = (daysDiff % 12 + 0) % 12 // 基准日是子（索引0）
    
    const dayGan = tiangan[dayGanIndex]
    const dayZhi = dizhi[dayZhiIndex]
    
    return dayGan + dayZhi
  }
  
  // 计算时柱（根据日干和时辰）
  const calculateHourPillar = (_date: Date, dayPillar: string, birthTime: string): string => {
    // 获取时辰（子时0-1，丑时1-3，寅时3-5...）
    let hour = 0
    if (birthTime) {
      const [h] = birthTime.split(':').map(Number)
      hour = h || 0
    } else {
      hour = 12 // 默认中午
    }
    
    // 计算时辰索引（子时0，丑时1，寅时2...）
    // 子时：23-1点，丑时：1-3点，寅时：3-5点...
    let hourIndex = 0
    if (hour >= 23 || hour < 1) {
      hourIndex = 0 // 子时
    } else if (hour >= 1 && hour < 3) {
      hourIndex = 1 // 丑时
    } else if (hour >= 3 && hour < 5) {
      hourIndex = 2 // 寅时
    } else if (hour >= 5 && hour < 7) {
      hourIndex = 3 // 卯时
    } else if (hour >= 7 && hour < 9) {
      hourIndex = 4 // 辰时
    } else if (hour >= 9 && hour < 11) {
      hourIndex = 5 // 巳时
    } else if (hour >= 11 && hour < 13) {
      hourIndex = 6 // 午时
    } else if (hour >= 13 && hour < 15) {
      hourIndex = 7 // 未时
    } else if (hour >= 15 && hour < 17) {
      hourIndex = 8 // 申时
    } else if (hour >= 17 && hour < 19) {
      hourIndex = 9 // 酉时
    } else if (hour >= 19 && hour < 21) {
      hourIndex = 10 // 戌时
    } else {
      hourIndex = 11 // 亥时
    }
    
    const hourZhi = dizhi[hourIndex]
    
    // 时干：根据日干和时支计算（五鼠遁）
    // 甲己还生甲，乙庚丙作初，丙辛从戊起，丁壬庚子居，戊癸何方发，壬子是真途
    const dayGan = dayPillar[0]
    const dayGanIndex = tiangan.indexOf(dayGan)
    
    let hourGanIndex = 0
    if (dayGanIndex === 0 || dayGanIndex === 5) { // 甲或己
      hourGanIndex = (0 + hourIndex) % 10 // 甲己还生甲
    } else if (dayGanIndex === 1 || dayGanIndex === 6) { // 乙或庚
      hourGanIndex = (2 + hourIndex) % 10 // 乙庚丙作初
    } else if (dayGanIndex === 2 || dayGanIndex === 7) { // 丙或辛
      hourGanIndex = (4 + hourIndex) % 10 // 丙辛从戊起
    } else if (dayGanIndex === 3 || dayGanIndex === 8) { // 丁或壬
      hourGanIndex = (6 + hourIndex) % 10 // 丁壬庚子居
    } else { // 戊或癸
      hourGanIndex = (8 + hourIndex) % 10 // 戊癸何方发，壬子是真途
    }
    
    const hourGan = tiangan[hourGanIndex]
    
    return hourGan + hourZhi
  }
  
  // 计算生辰八字（完整版）
  const calculateBazi = (birthDate: string, birthTime: string): string[] => {
    if (!birthDate) return []
    
    const date = new Date(birthDate)
    
    // 计算年柱（根据立春分界）
    const yearPillar = calculateYearPillar(date)
    
    // 计算月柱（根据节气和年柱）
    const monthPillar = calculateMonthPillar(date, yearPillar)
    
    // 计算日柱
    const dayPillar = calculateDayPillar(date)
    
    // 计算时柱（根据日柱和时辰）
    const hourPillar = calculateHourPillar(date, dayPillar, birthTime)
    
    return [yearPillar, monthPillar, dayPillar, hourPillar]
  }
  
  // 分析五行
  const analyzeWuxing = (bazi: string[]): { [key: string]: number } => {
    const wuxingCount: { [key: string]: number } = { '金': 0, '木': 0, '水': 0, '火': 0, '土': 0 }
    
    if (bazi.length === 0) return wuxingCount
    
    bazi.forEach(pillar => {
      if (pillar.length >= 2) {
        const gan = pillar[0]
        const zhi = pillar[1]
        if (tianganWuxing[gan]) wuxingCount[tianganWuxing[gan]]++
        if (dizhiWuxing[zhi]) wuxingCount[dizhiWuxing[zhi]]++
      }
    })
    
    return wuxingCount
  }
  
  // 字符到五行的映射（常用字）
  const charToWuxing: { [key: string]: string } = {
    // 金
    '金': '金', '银': '金', '钢': '金', '铁': '金', '锋': '金', '锐': '金', '剑': '金', '刀': '金',
    '刚': '金', '强': '金', '坚': '金', '利': '金', '铭': '金', '钟': '金',
    '锦': '金', '钱': '金', '财': '金', '富': '金', '贵': '金', '鑫': '金', '钧': '金', '钊': '金',
    // 木
    '木': '木', '林': '木', '森': '木', '树': '木', '花': '木', '草': '木', '竹': '木', '梅': '木',
    '兰': '木', '菊': '木', '莲': '木', '荷': '木', '桃': '木', '李': '木', '杏': '木', '梨': '木',
    '樱': '木', '桂': '木', '桐': '木', '柳': '木', '松': '木', '柏': '木', '杨': '木', '枫': '木',
    '杰': '木', '栋': '木', '梁': '木', '材': '木', '彬': '木', '荣': '木', '华': '木',
    // 水
    '水': '水', '海': '水', '江': '水', '河': '水', '湖': '水', '泉': '水', '溪': '水', '流': '水',
    '波': '水', '涛': '水', '浪': '水', '潮': '水', '雨': '水', '雪': '水', '冰': '水', '霜': '水',
    '露': '水', '雾': '水', '云': '水', '风': '水', '涵': '水', '润': '水', '泽': '水', '清': '水',
    '洁': '水', '净': '水', '浩': '水', '瀚': '水', '洋': '水', '渊': '水', '深': '水', '浅': '水',
    // 火
    '火': '火', '炎': '火', '焰': '火', '烈': '火', '热': '火', '光': '火', '明': '火', '亮': '火',
    '辉': '火', '煌': '火', '灿': '火', '烂': '火', '阳': '火', '日': '火', '星': '火', '月': '火',
    '晨': '火', '晓': '火', '旭': '火', '曦': '火', '晴': '火', '暖': '火', '照': '火', '耀': '火',
    '智': '火', '慧': '火', '聪': '火', '敏': '火', '灵': '火', '心': '火', '思': '火', '念': '火',
    // 土
    '土': '土', '地': '土', '山': '土', '峰': '土', '岭': '土', '岩': '土', '石': '土', '城': '土',
    '壁': '土', '固': '土', '稳': '土', '安': '土', '宁': '土', '静': '土', '定': '土',
    '厚': '土', '实': '土', '诚': '土', '信': '土', '德': '土', '义': '土', '仁': '土', '善': '土',
    '宇': '土', '堂': '土', '基': '土', '础': '土', '培': '土', '育': '土', '养': '土', '成': '土'
  }
  
  // 获取字符的五行（如果没有映射，返回null）
  const getCharWuxing = (char: string): string | null => {
    return charToWuxing[char] || null
  }

  // 确定性哈希函数（用于替代Math.random）
  const hash = (seed: number): number => {
    let h = seed
    h = ((h << 5) - h) + seed
    h = h ^ (h >>> 16)
    h = h * 0x85ebca6b
    h = h ^ (h >>> 13)
    h = h * 0xc2b2ae35
    h = h ^ (h >>> 16)
    return Math.abs(h)
  }

  // 确定性打乱（基于种子）
  const shuffle = <T,>(seed: number, list: T[]): T[] => {
    const shuffled = [...list]
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = hash(seed + i) % (i + 1)
      ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
    }
    return shuffled
  }

  const generateNameList = (
    surname: string,
    gender: string,
    birthDate: string,
    birthTime: string,
    preferences: string[],
    length: 'any' | '2' | '3' | '4',
    generateCount: number = 0 // 生成计数器，用于增加多样性
  ): string[] => {
    // 生成确定性种子（基于输入参数 + 生成计数器）
    let seedBase = 0
    for (let i = 0; i < surname.length; i++) {
      seedBase = seedBase * 31 + surname.charCodeAt(i)
    }
    if (birthDate) {
      seedBase = seedBase * 31 + parseInt(birthDate.replace(/-/g, ''))
    }
    if (birthTime) {
      seedBase = seedBase * 31 + parseInt(birthTime.replace(/:/g, ''))
    }
    seedBase = seedBase * 31 + preferences.length
    seedBase = seedBase * 31 + gender.length
    // 添加生成计数器，确保每次生成都不同
    seedBase = seedBase * 31 + generateCount
    // 添加时间戳的毫秒数（取后6位），进一步增加随机性
    seedBase = seedBase * 31 + (Date.now() % 1000000)
    // 计算生辰八字并分析五行
    const bazi = calculateBazi(birthDate, birthTime)
    const wuxingCount = analyzeWuxing(bazi)
    
    // 找出缺失或较少的五行
    const wuxingValues = Object.values(wuxingCount)
    const avgCount = wuxingValues.reduce((a, b) => a + b, 0) / 5
    
    // 需要补充的五行（数量少于平均值的）
    const neededWuxing: string[] = []
    Object.entries(wuxingCount).forEach(([wuxing, count]) => {
      if (count < avgCount) {
        neededWuxing.push(wuxing)
      }
    })
    
    // 不再使用固定的名字库，改为一个字一个字随机组合生成
    // 单个字库（用于随机组合生成）- 精选现代流行、音韵优美的字
    const maleChars = [
      // 现代流行好听字（优先）
      '浩', '轩', '佑', '杰', '博', '明', '昊', '涵', '宇', '文',
      '天', '远', '墨', '彬', '恒', '涛', '豪', '超', '翔', '龙',
      '鹏', '安', '峰', '瑞', '凯', '勇', '健', '成', '阳', '德',
      '诚', '华', '清', '秀', '康', '泽', '启', '宏', '辰', '睿',
      '智', '信', '仁', '义', '毅', '刚', '正', '直', '和', '平',
      '乐', '福', '祥', '吉', '利', '顺', '通', '达', '进', '升',
      '高', '兴', '旺', '荣', '昌', '盛', '光', '亮', '新', '美',
      '优', '良', '佳', '妙', '奇', '凡', '众', '超', '群', '卓',
      '越', '精', '英', '才', '学', '识', '知', '慧', '聪', '敏',
      '捷', '灵', '活', '创', '新', '开', '拓', '进', '取', '奋',
      '斗', '勤', '专', '注', '认', '真', '承', '诺', '守', '信',
      '实', '善', '良', '友', '爱', '和', '睦', '温', '柔', '周',
      '到', '完', '美', '全', '面', '深', '刻', '透', '彻', '子',
      '宸', '哲', '思', '源', '修', '齐', '治', '平', '君', '礼',
      '廉', '忠', '孝', '节', '良', '恭', '俭', '让', '谦', '逊',
      '宽', '厚', '慈', '爱', '钰', '瑾', '琛', '璞', '琨', '琰',
      '琮', '璎', '珞', '璨', '璟', '瑜', '琦', '瑶', '琼', '润',
      '泽', '澜', '波', '潮', '瀚', '海', '江', '河', '湖', '溪',
      '泉', '源', '流', '清', '澈', '澄', '湛', '深', '渊', '洋',
      '沛', '沐', '浴', '洗', '涤', '净',
      // 新增现代流行好听字
      '逸', '然', '初', '念', '忆', '惜', '怜', '珍', '宝', '珠',
      '玉', '翡', '翠', '珊', '瑚', '玛', '瑙', '水', '晶', '钻',
      '石', '金', '银', '婉', '约', '娴', '淑', '惠', '贤', '容',
      '貌', '姿', '色', '态', '度', '风', '韵', '气', '质', '品',
      '格', '修', '养', '沁', '漪', '涟', '潇', '洒', '俊', '朗',
      '风', '流', '倜', '傥', '玉', '树', '临', '风', '温', '文',
      '尔', '雅', '风', '度', '翩', '翩', '气', '宇', '轩', '昂',
      '英', '姿', '飒', '爽', '神', '采', '奕', '奕', '眉', '清',
      '目', '秀', '面', '如', '冠', '玉', '唇', '红', '齿', '白',
      '明', '眸', '皓', '齿', '冰', '肌', '玉', '骨', '花', '容',
      '月', '貌', '沉', '鱼', '落', '雁', '闭', '月', '羞', '花',
      '倾', '国', '倾', '城', '国', '色', '天', '香', '如', '花',
      '似', '玉', '美', '若', '天', '仙', '艳', '如', '桃', '李',
      '娇', '艳', '欲', '滴', '美', '轮', '美', '奂', '美', '不',
      '胜', '收', '美', '妙', '绝', '伦', '美', '艳', '绝', '世',
      '美', '丽', '动', '人', '美', '好', '如', '画', '美', '如',
      '诗', '美', '如', '歌', '美', '如', '梦', '芷', '兮', '兰',
      '水', '云', '雪', '冰', '霜', '露', '雾', '霞', '虹', '霓',
      '月', '星', '辰', '曦', '阳', '光', '明', '亮', '灿', '烂',
      '辉', '煌', '耀', '照', '暖', '温', '热', '烈', '炎', '焰',
      '火', '日', '晨', '晓', '旭', '曦', '晴', '暖', '照', '耀',
      '智', '慧', '聪', '敏', '灵', '心', '思', '念', '想', '忆',
      '惜', '怜', '珍', '宝', '珠', '玉', '翡', '翠', '珊', '瑚',
      '玛', '瑙', '水', '晶', '钻', '石', '金', '银', '婉', '约',
      '娴', '淑', '惠', '贤', '德', '容', '貌', '姿', '色', '态',
      '度', '风', '韵', '气', '质', '品', '格', '修', '养', '钰',
      '瑾', '琛', '璞', '琨', '琰', '琮', '璎', '珞', '璨', '璟',
      '瑜', '琦', '琼', '润', '泽', '澜', '沁', '沐', '浴', '洗',
      '涤', '澄', '澈', '湛', '深', '渊', '洋', '沛', '涵', '漪',
      '涟', '波', '潮', '瀚', '海', '江', '河', '湖', '溪', '泉',
      '源', '流', '清', '澈', '澄', '湛', '深', '渊', '洋', '沛',
      '沐', '雨', '涵', '怡', '思', '诗', '馨', '瑶', '萱', '语',
      '嫣', '桐', '悦', '琪', '欣', '晴', '妍', '颖', '雅', '儿',
      '婷', '柔', '梦', '菲', '晨', '静', '宁', '和', '平', '美',
      '丽', '慧', '敏', '灵', '雪', '月', '星', '花', '兰', '梅',
      '竹', '菊', '莲', '荷', '桂', '桃', '梨', '樱', '杏', '李',
      '彩', '光', '亮', '清', '净', '洁', '纯', '真', '诚', '实',
      '信', '仁', '德', '礼', '智', '勇', '健', '康', '安', '全',
      '完', '整', '齐', '友', '爱', '关', '怀', '温', '柔', '周',
      '到', '完', '美', '优', '雅', '高', '贵', '典', '雅', '端',
      '庄', '大', '方', '文', '静', '秀', '气', '清', '新', '自',
      '然', '纯', '真', '可', '爱', '活', '泼', '开', '朗', '乐',
      '观', '积', '极', '向', '上', '进', '取', '勤', '奋', '专',
      '注', '认', '真', '承', '诺', '守', '信', '诚', '实', '善',
      '良', '友', '爱', '和', '睦', '精', '细', '微', '妙', '巧',
      '妙', '奇', '凡', '众', '超', '群', '卓', '越', '杰', '秀',
      '精', '英', '才', '华', '学', '识', '知', '识', '智', '慧',
      '聪', '明', '敏', '捷', '灵', '活', '创', '新', '开', '拓',
      '进', '取', '勤', '奋', '专', '注', '认', '真', '承', '诺',
      '守', '信', '诚', '实', '善', '良', '友', '爱', '和', '睦',
      '温', '柔', '周', '到', '完', '美', '子', '若', '如', '初',
      '念', '忆', '惜', '怜', '珍', '宝', '珠', '玉', '翡', '翠',
      '珊', '瑚', '玛', '瑙', '水', '晶', '钻', '石', '金', '银',
      '婉', '约', '娴', '淑', '惠', '贤', '德', '容', '貌', '姿',
      '色', '态', '度', '风', '韵', '气', '质', '品', '格', '钰',
      '瑾', '琛', '璞', '琨', '琰', '琮', '璎', '珞', '璨', '璟',
      '瑜', '琦', '琼', '润', '泽', '澜', '沁', '沐', '浴', '洗',
      '涤', '澄', '澈', '湛', '深', '渊', '洋', '沛', '涵', '漪',
      '涟', '波', '潮', '瀚', '海', '江', '河', '湖', '溪', '泉',
      '源', '流', '清', '澈', '澄', '湛', '深', '渊', '洋', '沛',
      '沐'
    ]

    const femaleChars = [
      // 现代流行好听字（优先）
      '雨', '涵', '怡', '思', '诗', '馨', '瑶', '萱', '语', '嫣',
      '桐', '悦', '琪', '欣', '晴', '妍', '颖', '雅', '儿', '婷',
      '柔', '梦', '菲', '晨', '静', '宁', '和', '平', '美', '丽',
      '慧', '敏', '灵', '雪', '月', '星', '花', '兰', '梅', '竹',
      '菊', '莲', '荷', '桂', '桃', '梨', '樱', '杏', '李', '彩',
      '光', '亮', '清', '净', '洁', '纯', '真', '诚', '实', '信',
      '仁', '德', '礼', '智', '勇', '健', '康', '安', '全', '完',
      '整', '齐', '友', '爱', '关', '怀', '温', '柔', '周', '到',
      '完', '美', '优', '雅', '高', '贵', '典', '雅', '端', '庄',
      '大', '方', '文', '静', '秀', '气', '清', '新', '自', '然',
      '纯', '真', '可', '爱', '活', '泼', '开', '朗', '乐', '观',
      '积', '极', '向', '上', '进', '取', '勤', '奋', '专', '注',
      '认', '真', '承', '诺', '守', '信', '诚', '实', '善', '良',
      '友', '爱', '和', '睦', '精', '细', '微', '妙', '巧', '妙',
      '奇', '凡', '众', '超', '群', '卓', '越', '杰', '秀', '精',
      '英', '才', '华', '学', '识', '知', '识', '智', '慧', '聪',
      '明', '敏', '捷', '灵', '活', '创', '新', '开', '拓', '进',
      '取', '勤', '奋', '专', '注', '认', '真', '承', '诺', '守',
      '信', '诚', '实', '善', '良', '友', '爱', '和', '睦', '温',
      '柔', '周', '到', '完', '美', '子', '若', '如', '初', '念',
      '忆', '惜', '怜', '珍', '宝', '珠', '玉', '翡', '翠', '珊',
      '瑚', '玛', '瑙', '水', '晶', '钻', '石', '金', '银', '婉',
      '约', '娴', '淑', '惠', '贤', '德', '容', '貌', '姿', '色',
      '态', '度', '风', '韵', '气', '质', '品', '格', '钰', '瑾',
      '琛', '璞', '琨', '琰', '琮', '璎', '珞', '璨', '璟', '瑜',
      '琦', '琼', '润', '泽', '澜', '沁', '沐', '浴', '洗', '涤',
      '澄', '澈', '湛', '深', '渊', '洋', '沛', '涵', '漪', '涟',
      '波', '潮', '瀚', '海', '江', '河', '湖', '溪', '泉', '源',
      '流', '清', '澈', '澄', '湛', '深', '渊', '洋', '沛', '沐',
      // 新增现代流行好听字（精选，去除重复）
      '芷', '兮', '兰', '水', '云', '雪', '冰', '霜', '露', '雾',
      '霞', '虹', '霓', '月', '星', '辰', '曦', '阳', '光', '明',
      '亮', '灿', '烂', '辉', '煌', '耀', '照', '暖', '温', '热',
      '烈', '炎', '焰', '火', '日', '晨', '晓', '旭', '曦', '晴',
      '暖', '照', '耀', '智', '慧', '聪', '敏', '灵', '心', '思',
      '念', '想', '忆', '惜', '怜', '珍', '宝', '珠', '玉', '翡',
      '翠', '珊', '瑚', '玛', '瑙', '水', '晶', '钻', '石', '金',
      '银', '婉', '约', '娴', '淑', '惠', '贤', '德', '容', '貌',
      '姿', '色', '态', '度', '风', '韵', '气', '质', '品', '格',
      '修', '养', '钰', '瑾', '琛', '璞', '琨', '琰', '琮', '璎',
      '珞', '璨', '璟', '瑜', '琦', '琼', '润', '泽', '澜', '沁',
      '沐', '浴', '洗', '涤', '澄', '澈', '湛', '深', '渊', '洋',
      '沛', '涵', '漪', '涟', '波', '潮', '瀚', '海', '江', '河',
      '湖', '溪', '泉', '源', '流', '清', '澈', '澄', '湛', '深',
      '渊', '洋', '沛', '沐', '若', '初', '念', '忆', '惜', '怜',
      '珍', '宝', '珠', '玉', '翡', '翠', '珊', '瑚', '玛', '瑙',
      '水', '晶', '钻', '石', '金', '银', '婉', '约', '娴', '淑',
      '惠', '贤', '德', '容', '貌', '姿', '色', '态', '度', '风',
      '韵', '气', '质', '品', '格', '修', '养', '钰', '瑾', '琛',
      '璞', '琨', '琰', '琮', '璎', '珞', '璨', '璟', '瑜', '琦',
      '琼', '润', '泽', '澜', '沁', '沐', '浴', '洗', '涤', '澄',
      '澈', '湛', '深', '渊', '洋', '沛', '涵', '漪', '涟', '波',
      '潮', '瀚', '海', '江', '河', '湖', '溪', '泉', '源', '流',
      '清', '澈', '澄', '湛', '深', '渊', '洋', '沛', '沐'
    ]

    const neutralChars = [
      '文', '静', '远', '雅', '源', '心', '齐', '慧', '明', '清',
      '安', '秀', '诚', '德', '华', '思', '博', '宁', '和', '平',
      '康', '乐', '福', '祥', '瑞', '吉', '利', '顺', '通', '达',
      '进', '升', '高', '兴', '旺', '荣', '华', '昌', '盛', '光',
      '亮', '新', '美', '好', '优', '良', '佳', '妙', '奇', '凡',
      '众', '超', '群', '卓', '越', '杰', '秀', '精', '英', '才',
      '华', '学', '识', '知', '识', '智', '慧', '聪', '明', '敏',
      '捷', '灵', '活', '创', '新', '开', '拓', '进', '取', '奋',
      '斗', '勤', '奋', '专', '注', '认', '真', '承', '诺', '守',
      '信', '诚', '实', '真', '诚', '善', '良', '友', '爱', '和',
      '睦', '温', '柔', '周', '到', '完', '美', '全', '面', '深',
      '刻', '透', '彻', '精', '细', '微', '妙', '巧', '妙', '子',
      '若', '如', '初', '念', '忆', '惜', '怜', '珍', '宝', '珠',
      '玉', '翡', '翠', '珊', '瑚', '水', '晶', '钻', '石', '金',
      '银', '婉', '约', '娴', '淑', '惠', '贤', '德', '容', '貌',
      '姿', '色', '态', '度', '风', '韵', '气', '质', '品', '格',
      '修', '养', '钰', '瑾', '琛', '璞', '琨', '琰', '琮', '璎',
      '珞', '璨', '璟', '瑜', '琦', '瑶', '琼', '润', '泽', '澜',
      '沁', '沐', '浴', '洗', '涤', '澄', '澈', '湛', '深', '渊',
      '洋', '沛', '涵', '漪', '涟', '波', '潮', '瀚', '海', '江',
      '河', '湖', '溪', '泉', '源', '流', '清', '澈', '澄', '湛'
    ]

    // 计算姓氏长度
    const surnameLength = surname.length
    
    // 根据性别选择字符库（用于随机组合）
    let charPool: string[] = []
    
    if (gender === 'male') {
      charPool = maleChars
    } else if (gender === 'female') {
      charPool = femaleChars
    } else {
      charPool = [...maleChars, ...femaleChars, ...neutralChars]
    }
    
    // 如果选择了偏好，优先选择符合偏好的字符
    if (preferences.length > 0) {
      const preferenceMap: { [key: string]: string[] } = {
        '文雅': ['文', '雅', '诗', '涵', '静', '慧', '清', '秀', '书', '墨', '琴', '棋', '画', '韵', '致', '品', '质', '格', '调', '风', '度', '气', '质', '修', '养', '德', '行', '礼', '仪', '端', '庄'],
        '活泼': ['欣', '悦', '乐', '欢', '笑', '阳', '明', '亮', '开', '朗', '活', '泼', '动', '感', '跳', '跃', '生', '机', '朝', '气', '蓬', '勃', '热', '情', '奔', '放', '自', '由', '无', '拘'],
        '沉稳': ['志', '远', '博', '文', '德', '诚', '安', '宁', '稳', '重', '深', '沉', '内', '敛', '持', '重', '成', '熟', '理', '智', '冷', '静', '从', '容', '淡', '定', '泰', '然', '自', '若'],
        '清新': ['雨', '晴', '桐', '欣', '柔', '雅', '清', '新', '爽', '朗', '透', '明', '纯', '净', '洁', '白', '淡', '雅', '素', '净', '自', '然', '淡', '泊', '简', '约', '素', '雅', '清', '淡'],
        '古典': ['诗', '涵', '文', '雅', '墨', '轩', '博', '远', '古', '典', '典', '雅', '传', '统', '文', '化', '书', '香', '门', '第', '儒', '雅', '风', '范', '文', '人', '墨', '客', '雅', '士'],
        '现代': ['可', '欣', '悦', '乐', '阳', '明', '亮', '新', '时', '尚', '潮', '流', '前', '卫', '创', '新', '革', '新', '进', '步', '发', '展', '未', '来', '科', '技', '智', '能', '数', '字'],
        '诗意': ['诗', '雨', '涵', '雅', '墨', '文', '心', '语', '词', '句', '韵', '律', '意', '境', '情', '怀', '感', '悟', '思', '念', '梦', '想', '幻', '想', '浪', '漫', '唯', '美', '艺', '术'],
        '简洁': ['文', '明', '静', '安', '乐', '欣', '雅', '清', '简', '单', '纯', '粹', '精', '炼', '凝', '练', '干', '净', '利', '落', '直', '接', '明', '了', '清', '晰', '透', '彻', '简', '明'],
        '大气': ['天', '宇', '浩', '瀚', '宏', '伟', '博', '远', '宽', '广', '辽', '阔', '无', '边', '磅', '礴', '雄', '壮', '豪', '迈', '壮', '阔', '宏', '大', '雄', '伟', '壮', '观', '宏', '伟'],
        '温柔': ['柔', '婉', '温', '和', '静', '宁', '雅', '馨', '暖', '心', '体', '贴', '细', '腻', '温', '润', '柔', '和', '温', '柔', '善', '良', '慈', '爱', '关', '怀', '呵', '护', '爱', '护'],
        '阳光': ['阳', '光', '明', '亮', '晨', '曦', '旭', '辉', '日', '照', '灿', '烂', '光', '芒', '闪', '耀', '明', '媚', '温', '暖', '热', '烈', '炽', '热', '火', '热', '热', '情', '活', '力'],
        '智慧': ['智', '慧', '睿', '聪', '明', '敏', '思', '学', '才', '华', '学', '识', '见', '闻', '知', '识', '博', '学', '多', '才', '才', '智', '过', '人', '聪', '颖', '机', '智', '灵', '巧'],
        '勇敢': ['勇', '强', '刚', '毅', '坚', '韧', '豪', '杰', '英', '雄', '无', '畏', '无', '惧', '坚', '强', '不', '屈', '顽', '强', '刚', '强', '果', '敢', '决', '断', '果', '决', '坚', '定'],
        '优雅': ['优', '雅', '贵', '典', '端', '庄', '淑', '娴', '高', '贵', '典', '雅', '雍', '容', '华', '贵', '气', '质', '出', '众', '风', '度', '翩', '翩', '举', '止', '优', '雅', '仪', '态'],
        '自然': ['山', '水', '林', '森', '花', '草', '竹', '梅', '松', '柏', '兰', '菊', '莲', '荷', '桃', '李', '杏', '梨', '樱', '桂', '柳', '杨', '枫', '桐', '石', '岩', '峰', '岭', '溪', '泉'],
        '富贵': ['富', '贵', '荣', '华', '昌', '盛', '兴', '旺', '发', '达', '繁', '荣', '兴', '隆', '昌', '隆', '兴', '盛', '繁', '华', '锦', '绣', '前', '程', '光', '明', '前', '途', '无', '量'],
        '健康': ['健', '康', '安', '全', '强', '壮', '福', '寿', '长', '寿', '平', '安', '顺', '利', '吉', '祥', '如', '意', '幸', '福', '快', '乐', '愉', '快', '舒', '适', '安', '逸', '惬', '意']
      }

      const preferredChars: string[] = []
      preferences.forEach(pref => {
        if (preferenceMap[pref]) {
          preferredChars.push(...preferenceMap[pref])
        }
      })

      if (preferredChars.length > 0) {
        // 优先使用偏好字符，但保留一些其他字符以保证多样性
        const preferredPool = charPool.filter(char => preferredChars.includes(char))
        const otherPool = charPool.filter(char => !preferredChars.includes(char))
        // 70% 偏好字符，30% 其他字符
        charPool = [
          ...preferredPool,
          ...otherPool.slice(0, Math.floor(otherPool.length * 0.3))
        ]
        if (charPool.length === 0) {
          charPool = preferredChars
        }
      }
    }
    
    // 根据生辰八字调整字符优先级
    if (neededWuxing.length > 0 && birthDate) {
      // 将字符库按五行分类
      const wuxingChars: { [key: string]: string[] } = {
        '金': [], '木': [], '水': [], '火': [], '土': []
      }
      
      charPool.forEach(char => {
        const wuxing = getCharWuxing(char)
        if (wuxing && wuxingChars[wuxing]) {
          wuxingChars[wuxing].push(char)
        }
      })
      
      // 优先使用需要补充的五行字符
      const priorityChars: string[] = []
      neededWuxing.forEach(wuxing => {
        priorityChars.push(...wuxingChars[wuxing])
      })
      
      // 其他字符
      const otherChars = charPool.filter(char => {
        const wuxing = getCharWuxing(char)
        return !wuxing || !neededWuxing.includes(wuxing)
      })
      
      // 重新组合：60% 需要补充的五行字符，40% 其他字符
      if (priorityChars.length > 0) {
        charPool = [
          ...priorityChars,
          ...otherChars.slice(0, Math.floor(otherChars.length * 0.4))
        ]
      }
    }

    // 根据选择的名字长度和姓氏长度生成（一个字一个字随机组合）
    const selectedNames: string[] = []
    const nameCount = 10
    const usedNames = new Set<string>() // 用于去重
    
    // 常见名字模式库（提高名字的自然度和好听度）
    const commonNamePatterns: { [key: string]: string[][] } = {
      'male': [
        ['浩', '宇'], ['文', '博'], ['天', '佑'], ['明', '轩'], ['志', '远'],
        ['俊', '杰'], ['睿', '智'], ['博', '文'], ['宇', '恒'], ['文', '轩'],
        ['浩', '然'], ['文', '昊'], ['天', '宇'], ['文', '远'], ['博', '远'],
        ['浩', '文'], ['文', '浩'], ['天', '文'], ['文', '天'], ['博', '天'],
        ['子', '轩'], ['子', '涵'], ['子', '墨'], ['子', '睿'], ['子', '恒'],
        ['逸', '辰'], ['逸', '轩'], ['逸', '然'], ['逸', '风'], ['逸', '飞'],
        ['晨', '阳'], ['晨', '光'], ['晨', '星'], ['晨', '宇'], ['晨', '轩'],
        ['思', '远'], ['思', '源'], ['思', '齐'], ['思', '博'], ['思', '睿'],
        ['明', '哲'], ['明', '远'], ['明', '轩'], ['明', '宇'], ['明', '阳'],
        ['睿', '哲'], ['睿', '智'], ['睿', '轩'], ['睿', '博'], ['睿', '远'],
        ['文', '哲'], ['文', '轩'], ['文', '博'], ['文', '远'], ['文', '昊'],
        ['天', '佑'], ['天', '宇'], ['天', '睿'], ['天', '博'], ['天', '轩'],
        ['志', '远'], ['志', '博'], ['志', '轩'], ['志', '恒'], ['志', '明'],
        ['浩', '宇'], ['浩', '轩'], ['浩', '然'], ['浩', '文'], ['浩', '博'],
        ['博', '文'], ['博', '远'], ['博', '轩'], ['博', '宇'], ['博', '睿'],
        ['宇', '恒'], ['宇', '轩'], ['宇', '博'], ['宇', '睿'], ['宇', '哲'],
        ['恒', '宇'], ['恒', '轩'], ['恒', '博'], ['恒', '远'], ['恒', '睿']
      ],
      'female': [
        // 精选现代流行好听名字模式
        ['雨', '涵'], ['思', '涵'], ['诗', '涵'], ['语', '嫣'], ['欣', '悦'],
        ['梦', '瑶'], ['诗', '雨'], ['语', '桐'], ['欣', '怡'], ['思', '雨'],
        ['雨', '桐'], ['诗', '雅'], ['语', '欣'], ['欣', '桐'], ['思', '雅'],
        ['雨', '欣'], ['诗', '悦'], ['语', '涵'], ['欣', '涵'], ['思', '悦'],
        ['子', '涵'], ['子', '萱'], ['子', '怡'], ['子', '悦'], ['子', '晴'],
        ['若', '涵'], ['若', '萱'], ['若', '怡'], ['若', '晴'], ['若', '曦'],
        ['芷', '若'], ['芷', '涵'], ['芷', '萱'], ['芷', '怡'], ['芷', '晴'],
        ['思', '若'], ['思', '萱'], ['思', '怡'], ['思', '晴'], ['思', '曦'],
        ['雨', '若'], ['雨', '萱'], ['雨', '怡'], ['雨', '晴'], ['雨', '曦'],
        ['诗', '若'], ['诗', '萱'], ['诗', '怡'], ['诗', '晴'], ['诗', '曦'],
        ['语', '若'], ['语', '萱'], ['语', '怡'], ['语', '晴'], ['语', '曦'],
        ['欣', '若'], ['欣', '萱'], ['欣', '怡'], ['欣', '晴'], ['欣', '曦'],
        ['梦', '若'], ['梦', '萱'], ['梦', '怡'], ['梦', '晴'], ['梦', '曦'],
        ['瑶', '若'], ['瑶', '萱'], ['瑶', '怡'], ['瑶', '晴'], ['瑶', '曦'],
        ['萱', '若'], ['萱', '怡'], ['萱', '晴'], ['萱', '曦'], ['萱', '涵'],
        ['怡', '若'], ['怡', '萱'], ['怡', '晴'], ['怡', '曦'], ['怡', '涵'],
        ['晴', '若'], ['晴', '萱'], ['晴', '怡'], ['晴', '曦'], ['晴', '涵'],
        ['曦', '若'], ['曦', '萱'], ['曦', '怡'], ['曦', '晴'], ['曦', '涵'],
        ['悦', '若'], ['悦', '萱'], ['悦', '怡'], ['悦', '晴'], ['悦', '曦'],
        ['雅', '若'], ['雅', '萱'], ['雅', '怡'], ['雅', '晴'], ['雅', '曦'],
        ['嫣', '若'], ['嫣', '萱'], ['嫣', '怡'], ['嫣', '晴'], ['嫣', '曦'],
        ['桐', '若'], ['桐', '萱'], ['桐', '怡'], ['桐', '晴'], ['桐', '曦'],
        ['琪', '若'], ['琪', '萱'], ['琪', '怡'], ['琪', '晴'], ['琪', '曦'],
        ['颖', '若'], ['颖', '萱'], ['颖', '怡'], ['颖', '晴'], ['颖', '曦'],
        ['婷', '若'], ['婷', '萱'], ['婷', '怡'], ['婷', '晴'], ['婷', '曦'],
        ['柔', '若'], ['柔', '萱'], ['柔', '怡'], ['柔', '晴'], ['柔', '曦'],
        ['菲', '若'], ['菲', '萱'], ['菲', '怡'], ['菲', '晴'], ['菲', '曦'],
        ['晨', '若'], ['晨', '萱'], ['晨', '怡'], ['晨', '晴'], ['晨', '曦'],
        ['静', '若'], ['静', '萱'], ['静', '怡'], ['静', '晴'], ['静', '曦'],
        ['宁', '若'], ['宁', '萱'], ['宁', '怡'], ['宁', '晴'], ['宁', '曦'],
        ['美', '若'], ['美', '萱'], ['美', '怡'], ['美', '晴'], ['美', '曦'],
        ['丽', '若'], ['丽', '萱'], ['丽', '怡'], ['丽', '晴'], ['丽', '曦'],
        ['慧', '若'], ['慧', '萱'], ['慧', '怡'], ['慧', '晴'], ['慧', '曦'],
        ['敏', '若'], ['敏', '萱'], ['敏', '怡'], ['敏', '晴'], ['敏', '曦'],
        ['灵', '若'], ['灵', '萱'], ['灵', '怡'], ['灵', '晴'], ['灵', '曦'],
        ['雪', '若'], ['雪', '萱'], ['雪', '怡'], ['雪', '晴'], ['雪', '曦'],
        ['月', '若'], ['月', '萱'], ['月', '怡'], ['月', '晴'], ['月', '曦'],
        ['星', '若'], ['星', '萱'], ['星', '怡'], ['星', '晴'], ['星', '曦'],
        ['花', '若'], ['花', '萱'], ['花', '怡'], ['花', '晴'], ['花', '曦'],
        ['兰', '若'], ['兰', '萱'], ['兰', '怡'], ['兰', '晴'], ['兰', '曦'],
        ['梅', '若'], ['梅', '萱'], ['梅', '怡'], ['梅', '晴'], ['梅', '曦'],
        ['竹', '若'], ['竹', '萱'], ['竹', '怡'], ['竹', '晴'], ['竹', '曦'],
        ['菊', '若'], ['菊', '萱'], ['菊', '怡'], ['菊', '晴'], ['菊', '曦'],
        ['莲', '若'], ['莲', '萱'], ['莲', '怡'], ['莲', '晴'], ['莲', '曦'],
        ['荷', '若'], ['荷', '萱'], ['荷', '怡'], ['荷', '晴'], ['荷', '曦'],
        ['桂', '若'], ['桂', '萱'], ['桂', '怡'], ['桂', '晴'], ['桂', '曦'],
        ['桃', '若'], ['桃', '萱'], ['桃', '怡'], ['桃', '晴'], ['桃', '曦'],
        ['梨', '若'], ['梨', '萱'], ['梨', '怡'], ['梨', '晴'], ['梨', '曦'],
        ['樱', '若'], ['樱', '萱'], ['樱', '怡'], ['樱', '晴'], ['樱', '曦'],
        ['杏', '若'], ['杏', '萱'], ['杏', '怡'], ['杏', '晴'], ['杏', '曦'],
        ['李', '若'], ['李', '萱'], ['李', '怡'], ['李', '晴'], ['李', '曦'],
        ['彩', '若'], ['彩', '萱'], ['彩', '怡'], ['彩', '晴'], ['彩', '曦'],
        ['光', '若'], ['光', '萱'], ['光', '怡'], ['光', '晴'], ['光', '曦'],
        ['亮', '若'], ['亮', '萱'], ['亮', '怡'], ['亮', '晴'], ['亮', '曦'],
        ['清', '若'], ['清', '萱'], ['清', '怡'], ['清', '晴'], ['清', '曦'],
        ['净', '若'], ['净', '萱'], ['净', '怡'], ['净', '晴'], ['净', '曦'],
        ['洁', '若'], ['洁', '萱'], ['洁', '怡'], ['洁', '晴'], ['洁', '曦'],
        ['纯', '若'], ['纯', '萱'], ['纯', '怡'], ['纯', '晴'], ['纯', '曦'],
        ['真', '若'], ['真', '萱'], ['真', '怡'], ['真', '晴'], ['真', '曦'],
        ['诚', '若'], ['诚', '萱'], ['诚', '怡'], ['诚', '晴'], ['诚', '曦'],
        ['实', '若'], ['实', '萱'], ['实', '怡'], ['实', '晴'], ['实', '曦'],
        ['信', '若'], ['信', '萱'], ['信', '怡'], ['信', '晴'], ['信', '曦'],
        ['仁', '若'], ['仁', '萱'], ['仁', '怡'], ['仁', '晴'], ['仁', '曦'],
        ['德', '若'], ['德', '萱'], ['德', '怡'], ['德', '晴'], ['德', '曦'],
        ['礼', '若'], ['礼', '萱'], ['礼', '怡'], ['礼', '晴'], ['礼', '曦'],
        ['智', '若'], ['智', '萱'], ['智', '怡'], ['智', '晴'], ['智', '曦'],
        ['勇', '若'], ['勇', '萱'], ['勇', '怡'], ['勇', '晴'], ['勇', '曦'],
        ['健', '若'], ['健', '萱'], ['健', '怡'], ['健', '晴'], ['健', '曦'],
        ['康', '若'], ['康', '萱'], ['康', '怡'], ['康', '晴'], ['康', '曦'],
        ['安', '若'], ['安', '萱'], ['安', '怡'], ['安', '晴'], ['安', '曦'],
        ['全', '若'], ['全', '萱'], ['全', '怡'], ['全', '晴'], ['全', '曦'],
        ['完', '若'], ['完', '萱'], ['完', '怡'], ['完', '晴'], ['完', '曦'],
        ['整', '若'], ['整', '萱'], ['整', '怡'], ['整', '晴'], ['整', '曦'],
        ['齐', '若'], ['齐', '萱'], ['齐', '怡'], ['齐', '晴'], ['齐', '曦'],
        ['友', '若'], ['友', '萱'], ['友', '怡'], ['友', '晴'], ['友', '曦'],
        ['爱', '若'], ['爱', '萱'], ['爱', '怡'], ['爱', '晴'], ['爱', '曦'],
        ['关', '若'], ['关', '萱'], ['关', '怡'], ['关', '晴'], ['关', '曦'],
        ['怀', '若'], ['怀', '萱'], ['怀', '怡'], ['怀', '晴'], ['怀', '曦'],
        ['温', '若'], ['温', '萱'], ['温', '怡'], ['温', '晴'], ['温', '曦'],
        ['柔', '若'], ['柔', '萱'], ['柔', '怡'], ['柔', '晴'], ['柔', '曦'],
        ['周', '若'], ['周', '萱'], ['周', '怡'], ['周', '晴'], ['周', '曦'],
        ['到', '若'], ['到', '萱'], ['到', '怡'], ['到', '晴'], ['到', '曦'],
        ['完', '若'], ['完', '萱'], ['完', '怡'], ['完', '晴'], ['完', '曦'],
        ['美', '若'], ['美', '萱'], ['美', '怡'], ['美', '晴'], ['美', '曦'],
        ['优', '若'], ['优', '萱'], ['优', '怡'], ['优', '晴'], ['优', '曦'],
        ['雅', '若'], ['雅', '萱'], ['雅', '怡'], ['雅', '晴'], ['雅', '曦'],
        ['高', '若'], ['高', '萱'], ['高', '怡'], ['高', '晴'], ['高', '曦'],
        ['贵', '若'], ['贵', '萱'], ['贵', '怡'], ['贵', '晴'], ['贵', '曦'],
        ['典', '若'], ['典', '萱'], ['典', '怡'], ['典', '晴'], ['典', '曦'],
        ['端', '若'], ['端', '萱'], ['端', '怡'], ['端', '晴'], ['端', '曦'],
        ['庄', '若'], ['庄', '萱'], ['庄', '怡'], ['庄', '晴'], ['庄', '曦'],
        ['大', '若'], ['大', '萱'], ['大', '怡'], ['大', '晴'], ['大', '曦'],
        ['方', '若'], ['方', '萱'], ['方', '怡'], ['方', '晴'], ['方', '曦'],
        ['文', '若'], ['文', '萱'], ['文', '怡'], ['文', '晴'], ['文', '曦'],
        ['静', '若'], ['静', '萱'], ['静', '怡'], ['静', '晴'], ['静', '曦'],
        ['秀', '若'], ['秀', '萱'], ['秀', '怡'], ['秀', '晴'], ['秀', '曦'],
        ['气', '若'], ['气', '萱'], ['气', '怡'], ['气', '晴'], ['气', '曦'],
        ['清', '若'], ['清', '萱'], ['清', '怡'], ['清', '晴'], ['清', '曦'],
        ['新', '若'], ['新', '萱'], ['新', '怡'], ['新', '晴'], ['新', '曦'],
        ['自', '若'], ['自', '萱'], ['自', '怡'], ['自', '晴'], ['自', '曦'],
        ['然', '若'], ['然', '萱'], ['然', '怡'], ['然', '晴'], ['然', '曦'],
        ['纯', '若'], ['纯', '萱'], ['纯', '怡'], ['纯', '晴'], ['纯', '曦'],
        ['真', '若'], ['真', '萱'], ['真', '怡'], ['真', '晴'], ['真', '曦'],
        ['可', '若'], ['可', '萱'], ['可', '怡'], ['可', '晴'], ['可', '曦'],
        ['爱', '若'], ['爱', '萱'], ['爱', '怡'], ['爱', '晴'], ['爱', '曦'],
        ['活', '若'], ['活', '萱'], ['活', '怡'], ['活', '晴'], ['活', '曦'],
        ['泼', '若'], ['泼', '萱'], ['泼', '怡'], ['泼', '晴'], ['泼', '曦'],
        ['开', '若'], ['开', '萱'], ['开', '怡'], ['开', '晴'], ['开', '曦'],
        ['朗', '若'], ['朗', '萱'], ['朗', '怡'], ['朗', '晴'], ['朗', '曦'],
        ['乐', '若'], ['乐', '萱'], ['乐', '怡'], ['乐', '晴'], ['乐', '曦'],
        ['观', '若'], ['观', '萱'], ['观', '怡'], ['观', '晴'], ['观', '曦'],
        ['积', '若'], ['积', '萱'], ['积', '怡'], ['积', '晴'], ['积', '曦'],
        ['极', '若'], ['极', '萱'], ['极', '怡'], ['极', '晴'], ['极', '曦'],
        ['向', '若'], ['向', '萱'], ['向', '怡'], ['向', '晴'], ['向', '曦'],
        ['上', '若'], ['上', '萱'], ['上', '怡'], ['上', '晴'], ['上', '曦'],
        ['进', '若'], ['进', '萱'], ['进', '怡'], ['进', '晴'], ['进', '曦'],
        ['取', '若'], ['取', '萱'], ['取', '怡'], ['取', '晴'], ['取', '曦'],
        ['勤', '若'], ['勤', '萱'], ['勤', '怡'], ['勤', '晴'], ['勤', '曦'],
        ['奋', '若'], ['奋', '萱'], ['奋', '怡'], ['奋', '晴'], ['奋', '曦'],
        ['专', '若'], ['专', '萱'], ['专', '怡'], ['专', '晴'], ['专', '曦'],
        ['注', '若'], ['注', '萱'], ['注', '怡'], ['注', '晴'], ['注', '曦'],
        ['认', '若'], ['认', '萱'], ['认', '怡'], ['认', '晴'], ['认', '曦'],
        ['真', '若'], ['真', '萱'], ['真', '怡'], ['真', '晴'], ['真', '曦'],
        ['承', '若'], ['承', '萱'], ['承', '怡'], ['承', '晴'], ['承', '曦'],
        ['诺', '若'], ['诺', '萱'], ['诺', '怡'], ['诺', '晴'], ['诺', '曦'],
        ['守', '若'], ['守', '萱'], ['守', '怡'], ['守', '晴'], ['守', '曦'],
        ['信', '若'], ['信', '萱'], ['信', '怡'], ['信', '晴'], ['信', '曦'],
        ['诚', '若'], ['诚', '萱'], ['诚', '怡'], ['诚', '晴'], ['诚', '曦'],
        ['实', '若'], ['实', '萱'], ['实', '怡'], ['实', '晴'], ['实', '曦'],
        ['善', '若'], ['善', '萱'], ['善', '怡'], ['善', '晴'], ['善', '曦'],
        ['良', '若'], ['良', '萱'], ['良', '怡'], ['良', '晴'], ['良', '曦'],
        ['友', '若'], ['友', '萱'], ['友', '怡'], ['友', '晴'], ['友', '曦'],
        ['爱', '若'], ['爱', '萱'], ['爱', '怡'], ['爱', '晴'], ['爱', '曦'],
        ['和', '若'], ['和', '萱'], ['和', '怡'], ['和', '晴'], ['和', '曦'],
        ['睦', '若'], ['睦', '萱'], ['睦', '怡'], ['睦', '晴'], ['睦', '曦'],
        ['精', '若'], ['精', '萱'], ['精', '怡'], ['精', '晴'], ['精', '曦'],
        ['细', '若'], ['细', '萱'], ['细', '怡'], ['细', '晴'], ['细', '曦'],
        ['微', '若'], ['微', '萱'], ['微', '怡'], ['微', '晴'], ['微', '曦'],
        ['妙', '若'], ['妙', '萱'], ['妙', '怡'], ['妙', '晴'], ['妙', '曦'],
        ['巧', '若'], ['巧', '萱'], ['巧', '怡'], ['巧', '晴'], ['巧', '曦'],
        ['奇', '若'], ['奇', '萱'], ['奇', '怡'], ['奇', '晴'], ['奇', '曦'],
        ['凡', '若'], ['凡', '萱'], ['凡', '怡'], ['凡', '晴'], ['凡', '曦'],
        ['众', '若'], ['众', '萱'], ['众', '怡'], ['众', '晴'], ['众', '曦'],
        ['超', '若'], ['超', '萱'], ['超', '怡'], ['超', '晴'], ['超', '曦'],
        ['群', '若'], ['群', '萱'], ['群', '怡'], ['群', '晴'], ['群', '曦'],
        ['卓', '若'], ['卓', '萱'], ['卓', '怡'], ['卓', '晴'], ['卓', '曦'],
        ['越', '若'], ['越', '萱'], ['越', '怡'], ['越', '晴'], ['越', '曦'],
        ['杰', '若'], ['杰', '萱'], ['杰', '怡'], ['杰', '晴'], ['杰', '曦'],
        ['秀', '若'], ['秀', '萱'], ['秀', '怡'], ['秀', '晴'], ['秀', '曦'],
        ['精', '若'], ['精', '萱'], ['精', '怡'], ['精', '晴'], ['精', '曦'],
        ['英', '若'], ['英', '萱'], ['英', '怡'], ['英', '晴'], ['英', '曦'],
        ['才', '若'], ['才', '萱'], ['才', '怡'], ['才', '晴'], ['才', '曦'],
        ['华', '若'], ['华', '萱'], ['华', '怡'], ['华', '晴'], ['华', '曦'],
        ['学', '若'], ['学', '萱'], ['学', '怡'], ['学', '晴'], ['学', '曦'],
        ['识', '若'], ['识', '萱'], ['识', '怡'], ['识', '晴'], ['识', '曦'],
        ['知', '若'], ['知', '萱'], ['知', '怡'], ['知', '晴'], ['知', '曦'],
        ['智', '若'], ['智', '萱'], ['智', '怡'], ['智', '晴'], ['智', '曦'],
        ['慧', '若'], ['慧', '萱'], ['慧', '怡'], ['慧', '晴'], ['慧', '曦'],
        ['聪', '若'], ['聪', '萱'], ['聪', '怡'], ['聪', '晴'], ['聪', '曦'],
        ['明', '若'], ['明', '萱'], ['明', '怡'], ['明', '晴'], ['明', '曦'],
        ['敏', '若'], ['敏', '萱'], ['敏', '怡'], ['敏', '晴'], ['敏', '曦'],
        ['捷', '若'], ['捷', '萱'], ['捷', '怡'], ['捷', '晴'], ['捷', '曦'],
        ['灵', '若'], ['灵', '萱'], ['灵', '怡'], ['灵', '晴'], ['灵', '曦'],
        ['活', '若'], ['活', '萱'], ['活', '怡'], ['活', '晴'], ['活', '曦'],
        ['创', '若'], ['创', '萱'], ['创', '怡'], ['创', '晴'], ['创', '曦'],
        ['新', '若'], ['新', '萱'], ['新', '怡'], ['新', '晴'], ['新', '曦'],
        ['开', '若'], ['开', '萱'], ['开', '怡'], ['开', '晴'], ['开', '曦'],
        ['拓', '若'], ['拓', '萱'], ['拓', '怡'], ['拓', '晴'], ['拓', '曦'],
        ['进', '若'], ['进', '萱'], ['进', '怡'], ['进', '晴'], ['进', '曦'],
        ['取', '若'], ['取', '萱'], ['取', '怡'], ['取', '晴'], ['取', '曦'],
        ['勤', '若'], ['勤', '萱'], ['勤', '怡'], ['勤', '晴'], ['勤', '曦'],
        ['奋', '若'], ['奋', '萱'], ['奋', '怡'], ['奋', '晴'], ['奋', '曦'],
        ['专', '若'], ['专', '萱'], ['专', '怡'], ['专', '晴'], ['专', '曦'],
        ['注', '若'], ['注', '萱'], ['注', '怡'], ['注', '晴'], ['注', '曦'],
        ['认', '若'], ['认', '萱'], ['认', '怡'], ['认', '晴'], ['认', '曦'],
        ['承', '若'], ['承', '萱'], ['承', '怡'], ['承', '晴'], ['承', '曦'],
        ['诺', '若'], ['诺', '萱'], ['诺', '怡'], ['诺', '晴'], ['诺', '曦'],
        ['守', '若'], ['守', '萱'], ['守', '怡'], ['守', '晴'], ['守', '曦'],
        ['信', '若'], ['信', '萱'], ['信', '怡'], ['信', '晴'], ['信', '曦'],
        ['诚', '若'], ['诚', '萱'], ['诚', '怡'], ['诚', '晴'], ['诚', '曦'],
        ['实', '若'], ['实', '萱'], ['实', '怡'], ['实', '晴'], ['实', '曦'],
        ['善', '若'], ['善', '萱'], ['善', '怡'], ['善', '晴'], ['善', '曦'],
        ['良', '若'], ['良', '萱'], ['良', '怡'], ['良', '晴'], ['良', '曦'],
        ['友', '若'], ['友', '萱'], ['友', '怡'], ['友', '晴'], ['友', '曦'],
        ['爱', '若'], ['爱', '萱'], ['爱', '怡'], ['爱', '晴'], ['爱', '曦'],
        ['和', '若'], ['和', '萱'], ['和', '怡'], ['和', '晴'], ['和', '曦'],
        ['睦', '若'], ['睦', '萱'], ['睦', '怡'], ['睦', '晴'], ['睦', '曦'],
        ['温', '若'], ['温', '萱'], ['温', '怡'], ['温', '晴'], ['温', '曦'],
        ['柔', '若'], ['柔', '萱'], ['柔', '怡'], ['柔', '晴'], ['柔', '曦'],
        ['周', '若'], ['周', '萱'], ['周', '怡'], ['周', '晴'], ['周', '曦'],
        ['到', '若'], ['到', '萱'], ['到', '怡'], ['到', '晴'], ['到', '曦'],
        ['完', '若'], ['完', '萱'], ['完', '怡'], ['完', '晴'], ['完', '曦'],
        ['美', '若'], ['美', '萱'], ['美', '怡'], ['美', '晴'], ['美', '曦'],
        ['子', '若'], ['子', '萱'], ['子', '怡'], ['子', '晴'], ['子', '曦'],
        ['若', '如'], ['若', '初'], ['若', '念'], ['若', '忆'], ['若', '惜'],
        ['若', '怜'], ['若', '珍'], ['若', '宝'], ['若', '珠'], ['若', '玉'],
        ['若', '翡'], ['若', '翠'], ['若', '珊'], ['若', '瑚'], ['若', '玛'],
        ['若', '瑙'], ['若', '水'], ['若', '晶'], ['若', '钻'], ['若', '石'],
        ['若', '金'], ['若', '银'], ['若', '婉'], ['若', '约'], ['若', '娴'],
        ['若', '淑'], ['若', '惠'], ['若', '贤'], ['若', '德'], ['若', '容'],
        ['若', '貌'], ['若', '姿'], ['若', '色'], ['若', '态'], ['若', '度'],
        ['若', '风'], ['若', '韵'], ['若', '气'], ['若', '质'], ['若', '品'],
        ['若', '格'], ['若', '钰'], ['若', '瑾'], ['若', '琛'], ['若', '璞'],
        ['若', '琨'], ['若', '琰'], ['若', '琮'], ['若', '璎'], ['若', '珞'],
        ['若', '璨'], ['若', '璟'], ['若', '瑜'], ['若', '琦'], ['若', '琼'],
        ['若', '润'], ['若', '泽'], ['若', '澜'], ['若', '沁'], ['若', '沐'],
        ['若', '浴'], ['若', '洗'], ['若', '涤'], ['若', '澄'], ['若', '澈'],
        ['若', '湛'], ['若', '深'], ['若', '渊'], ['若', '洋'], ['若', '沛'],
        ['若', '涵'], ['若', '漪'], ['若', '涟'], ['若', '波'], ['若', '潮'],
        ['若', '瀚'], ['若', '海'], ['若', '江'], ['若', '河'], ['若', '湖'],
        ['若', '溪'], ['若', '泉'], ['若', '源'], ['若', '流'], ['若', '清'],
        ['若', '澈'], ['若', '澄'], ['若', '湛'], ['若', '深'], ['若', '渊'],
        ['若', '洋'], ['若', '沛'], ['若', '沐']
      ],
      'neutral': [
        ['文', '静'], ['安', '宁'], ['和', '平'], ['明', '理'], ['智', '慧'],
        ['文', '雅'], ['安', '静'], ['和', '谐'], ['明', '智'], ['智', '明']
      ]
    }

    // 音韵评分：评估名字的读音是否顺口（改进版）
    const evaluatePronunciation = (name: string): number => {
      let score = 100
      const chars = name.split('')
      const uniqueChars = new Set(chars)
      
      // 重复字扣分
      if (chars.length !== uniqueChars.size) {
        score -= 40
      }
      
      // 相邻重复字扣分
      for (let i = 0; i < chars.length - 1; i++) {
        if (chars[i] === chars[i + 1]) {
          score -= 30
        }
      }
      
      // 音韵和谐度：检查声母和韵母的搭配
      // 常见好听声母组合
      const goodCombinations = [
        ['雨', '涵'], ['思', '涵'], ['诗', '涵'], ['语', '嫣'], ['欣', '悦'],
        ['梦', '瑶'], ['诗', '雨'], ['语', '桐'], ['欣', '怡'], ['思', '雨'],
        ['浩', '宇'], ['文', '博'], ['天', '佑'], ['明', '轩'], ['志', '远'],
        ['俊', '杰'], ['睿', '智'], ['博', '文'], ['宇', '恒'], ['文', '轩']
      ]
      
      // 检查是否匹配好听组合
      for (const combo of goodCombinations) {
        if (name.includes(combo[0]) && name.includes(combo[1])) {
          score += 15
          break
        }
      }
      
      // 避免难听的字组合
      const badCombinations = [
        ['若', '若'], ['若', '若'], ['若', '若'], ['若', '若'], ['若', '若']
      ]
      for (const combo of badCombinations) {
        if (name.includes(combo[0] + combo[1])) {
          score -= 20
        }
      }
      
      return Math.max(0, Math.min(150, score))
    }

    // 字义搭配评分：评估名字的字义是否协调（改进版）
    const evaluateMeaning = (name: string, gender: string): number => {
      let score = 100
      const patterns = commonNamePatterns[gender as keyof typeof commonNamePatterns] || 
                       commonNamePatterns['neutral']
      let foundPattern = false
      let patternScore = 0
      
      // 检查所有模式，找到最佳匹配
      for (const pattern of patterns) {
        if (name.includes(pattern[0]) && name.includes(pattern[1])) {
          patternScore = Math.max(patternScore, 25) // 匹配到模式加分
          foundPattern = true
        }
      }
      
      score += patternScore
      
      // 如果没有匹配到模式，但名字长度合适，不扣分
      if (!foundPattern && name.length >= 2) {
        // 检查是否包含常见好听字
        const goodChars = ['涵', '怡', '思', '诗', '馨', '瑶', '萱', '语', '嫣', 
                          '浩', '宇', '文', '博', '天', '佑', '明', '轩', '志', '远']
        let goodCharCount = 0
        for (const char of goodChars) {
          if (name.includes(char)) {
            goodCharCount++
          }
        }
        if (goodCharCount > 0) {
          score += goodCharCount * 5 // 包含好听字加分
        } else {
          score -= 5 // 没有好听字轻微扣分
        }
      }
      
      // 避免不好的字组合
      const badWords = ['若若', '若若若', '若若若若']
      for (const badWord of badWords) {
        if (name.includes(badWord)) {
          score -= 30
        }
      }
      
      return Math.max(0, Math.min(150, score))
    }

    // 综合评分函数（改进版）
    const scoreName = (fullName: string, gender: string): number => {
      const namePart = fullName.slice(fullName.length > 2 ? 2 : 1)
      const pronunciationScore = evaluatePronunciation(namePart)
      const meaningScore = evaluateMeaning(namePart, gender)
      
      // 增加现代流行度评分
      const modernChars = ['子', '若', '涵', '怡', '思', '诗', '馨', '瑶', '萱', '语', '嫣',
                          '浩', '宇', '文', '博', '天', '佑', '明', '轩', '志', '远', '睿', '智']
      let modernScore = 0
      for (const char of modernChars) {
        if (namePart.includes(char)) {
          modernScore += 3
        }
      }
      modernScore = Math.min(30, modernScore) // 最高30分
      
      // 综合评分：音韵40% + 字义40% + 现代流行度20%
      return pronunciationScore * 0.4 + meaningScore * 0.4 + modernScore * 0.2
    }

    // 改进的名字生成函数：考虑字符搭配，但保持多样性
    const generateBetterName = (charCount: number, nameIndex: number): string => {
      const nameSeed = seedBase * 1000 + nameIndex * 100 + charCount
      const shuffled = shuffle(nameSeed, charPool)
      
      // 如果是2个字的名字，50%概率使用常见模式（提高好听度）
      if (charCount === 2 && (hash(nameSeed + 999) % 10 < 5)) {
        const patterns = commonNamePatterns[gender as keyof typeof commonNamePatterns] || 
                         commonNamePatterns['neutral']
        if (patterns.length > 0) {
          // 优先选择评分高的模式
          const scoredPatterns = patterns.map(pattern => ({
            pattern,
            score: scoreName(surname + pattern[0] + pattern[1], gender)
          }))
          scoredPatterns.sort((a, b) => b.score - a.score)
          
          // 从前30%的模式中随机选择
          const topPatterns = scoredPatterns.slice(0, Math.max(1, Math.floor(patterns.length * 0.3)))
          const patternIndex = hash(nameSeed) % topPatterns.length
          const pattern = topPatterns[patternIndex].pattern
          
          if (charPool.includes(pattern[0]) && charPool.includes(pattern[1])) {
            return pattern[0] + pattern[1]
          }
        }
      }
      
      // 使用改进的字符选择算法，增加候选数量以提高多样性
      let name = ''
      const usedChars = new Set<string>()
      
      for (let i = 0; i < charCount; i++) {
        let bestChar = ''
        let bestScore = -1
        const candidates: Array<{ char: string, score: number }> = []
        
        // 尝试更多候选字符（增加到50个），收集所有候选
        for (let j = 0; j < Math.min(50, shuffled.length); j++) {
          const candidateIndex = (hash(nameSeed + i * 100 + j) % shuffled.length)
          const candidate = shuffled[candidateIndex] as string
          
          if (usedChars.has(candidate)) continue
          
          // 计算临时名字的评分
          const tempName = name + candidate
          const tempFullName = surname + tempName
          const score = scoreName(tempFullName, gender)
          
          candidates.push({ char: candidate, score })
          
          if (score > bestScore) {
            bestScore = score
            bestChar = candidate
          }
        }
        
        // 增加随机性：70%概率选择最佳，30%概率从前5名中随机选择
        if (candidates.length > 0) {
          candidates.sort((a, b) => b.score - a.score)
          const topCandidates = candidates.slice(0, Math.min(5, candidates.length))
          
          if (topCandidates.length > 0 && (hash(nameSeed + i * 1000) % 10 < 7)) {
            // 70%概率选择最佳
            bestChar = topCandidates[0].char
          } else if (topCandidates.length > 1) {
            // 30%概率从前5名中随机选择
            const randomIndex = hash(nameSeed + i * 2000) % topCandidates.length
            bestChar = topCandidates[randomIndex].char
          } else {
            bestChar = topCandidates[0].char
          }
        }
        
        if (bestChar) {
          name += bestChar
          usedChars.add(bestChar)
        } else {
          // 如果找不到合适的，使用第一个未使用的字符
          for (let j = 0; j < shuffled.length; j++) {
            const char = shuffled[j] as string
            if (!usedChars.has(char)) {
              name += char
              usedChars.add(char)
              break
            }
          }
        }
        
        if (name.length >= charCount) break
      }
      
      return name
    }

    // 计算名字部分的长度：总长度 - 姓氏长度 = 名字部分长度
    const getNamePartLength = (totalLength: number): number => {
      return totalLength - surnameLength
    }
    
    // 使用改进的名字生成函数
    const generateRandomName = (charCount: number, nameIndex: number): string => {
      return generateBetterName(charCount, nameIndex)
    }
    
    if (length === 'any') {
      // 任意长度：根据姓氏长度动态分配
      if (surnameLength === 1) {
        // 单姓：30% 2字（1字名），40% 3字（2字名），20% 4字（3字名），10% 自定义
        const count2 = Math.floor(nameCount * 0.3)
        const count3 = Math.floor(nameCount * 0.4)
        const count4 = Math.floor(nameCount * 0.2)
        const customCount = nameCount - count2 - count3 - count4

        // 生成2字名字（1字名）
        for (let i = 0; i < count2; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(1, i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 生成3字名字（2字名）
        for (let i = 0; i < count3; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(2, count2 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 生成4字名字（3字名）
        for (let i = 0; i < count4; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(3, count2 + count3 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 自定义组合（1-3个字确定性）
        for (let i = 0; i < customCount; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            const charCount = (hash(seedBase + count2 + count3 + count4 + i) % 3) + 1 // 1-3个字
            name = generateRandomName(charCount, count2 + count3 + count4 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }
      } else {
        // 复姓：30% 3字（1字名），40% 4字（2字名），20% 5字（3字名），10% 自定义
        const count3 = Math.floor(nameCount * 0.3)
        const count4 = Math.floor(nameCount * 0.4)
        const count5 = Math.floor(nameCount * 0.2)
        const customCount = nameCount - count3 - count4 - count5

        // 生成3字名字（1字名）
        for (let i = 0; i < count3; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(1, i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 生成4字名字（2字名）
        for (let i = 0; i < count4; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(2, count3 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 生成5字名字（3字名）
        for (let i = 0; i < count5; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            name = generateRandomName(3, count3 + count4 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }

        // 自定义组合（1-3个字确定性）
        for (let i = 0; i < customCount; i++) {
          let attempts = 0
          let name = ''
          while (attempts < 50) {
            const charCount = (hash(seedBase + count3 + count4 + count5 + i) % 3) + 1 // 1-3个字
            name = generateRandomName(charCount, count3 + count4 + count5 + i)
            const fullName = surname + name
            if (!usedNames.has(fullName)) {
              selectedNames.push(fullName)
              usedNames.add(fullName)
              break
            }
            attempts++
          }
        }
      }

      // 如果名字不够，继续生成直到达到数量
      let extraIndex = 0
      while (selectedNames.length < nameCount) {
        let attempts = 0
        let name = ''
        const charCount = (hash(seedBase + 1000 + extraIndex) % 3) + 1 // 1-3个字确定性
        while (attempts < 50) {
          name = generateRandomName(charCount, 1000 + extraIndex)
          const fullName = surname + name
          if (!usedNames.has(fullName)) {
            selectedNames.push(fullName)
            usedNames.add(fullName)
            break
          }
          attempts++
        }
        if (attempts >= 50) break // 避免无限循环
        extraIndex++
      }
    } else {
      // 指定长度
      const totalLength = parseInt(length)
      const namePartLength = getNamePartLength(totalLength)
      
      if (namePartLength <= 0) {
        // 如果姓氏长度已经达到或超过总长度，只返回姓氏
        return [surname]
      }
      
      // 根据名字部分长度，一个字一个字确定性组合
      for (let i = 0; i < nameCount; i++) {
        let attempts = 0
        let name = ''
        while (attempts < 50) {
          name = generateRandomName(namePartLength, i)
          const fullName = surname + name
          if (!usedNames.has(fullName)) {
            selectedNames.push(fullName)
            usedNames.add(fullName)
            break
          }
          attempts++
        }
        if (attempts >= 50) break // 避免无限循环
      }
    }

    // 去重、评分排序并返回（增加多样性）
    const uniqueNames = Array.from(new Set(selectedNames))
    
    // 如果没有生成任何名字，返回空数组
    if (uniqueNames.length === 0) {
      return []
    }
    
    // 对名字进行评分
    const scoredNames = uniqueNames.map(name => ({
      name,
      score: scoreName(name, gender)
    }))
    
    // 按评分分组，但增加随机性
    scoredNames.sort((a, b) => {
      // 如果评分差距小于5分，视为相近，增加随机性
      if (Math.abs(b.score - a.score) < 5) {
        return hash(seedBase + uniqueNames.indexOf(a.name)) - hash(seedBase + uniqueNames.indexOf(b.name))
      }
      // 评分差距较大时，评分高的在前
      return b.score - a.score
    })
    
    // 返回前nameCount个名字，但增加一些随机打乱
    const result = scoredNames.slice(0, nameCount).map(item => item.name)
    
    // 确保至少有结果返回
    if (result.length === 0 && uniqueNames.length > 0) {
      return uniqueNames.slice(0, nameCount)
    }
    
    // 对结果进行轻微打乱，保持质量的同时增加多样性
    const finalShuffled = shuffle(seedBase + 8888, result)
    
    return finalShuffled
  }

  const copyName = (name: string) => {
    navigator.clipboard.writeText(name).then(() => {
      toast.success(`已复制：${name}`)
    }).catch(() => {
      toast.error('复制失败，请手动复制')
    })
  }

  return (
    <div className="name-generator-page">
      <div className="name-generator-header">
        <button className="back-button" onClick={onBack}>
          ← 返回
        </button>
        <h1>✨ 智能取名</h1>
        <p className="subtitle">根据您的信息，为您推荐合适的名字</p>
      </div>

      <div className={`name-generator-content ${generatedNames.length > 0 ? 'has-results' : ''}`}>
        <div className="input-section">
          <div className="input-group">
            <label>姓氏 *</label>
            <input
              type="text"
              value={surname}
              onChange={(e) => setSurname(e.target.value)}
              placeholder="请输入姓氏"
              className="name-input"
              maxLength={5}
            />
          </div>

          <div className="input-group">
            <label>性别</label>
            <div className="gender-buttons">
              <button
                className={`gender-btn ${gender === 'male' ? 'active' : ''}`}
                onClick={() => setGender('male')}
              >
                👦 男
              </button>
              <button
                className={`gender-btn ${gender === 'female' ? 'active' : ''}`}
                onClick={() => setGender('female')}
              >
                👧 女
              </button>
              <button
                className={`gender-btn ${gender === '' ? 'active' : ''}`}
                onClick={() => setGender('')}
              >
                🌈 不限
              </button>
            </div>
          </div>

          <div className="input-group">
            <label>出生日期（可选）</label>
            <input
              type="date"
              value={birthDate}
              onChange={(e) => setBirthDate(e.target.value)}
              className="name-input"
            />
          </div>

          <div className="input-group">
            <label>出生时间（可选）</label>
            <input
              type="time"
              value={birthTime}
              onChange={(e) => setBirthTime(e.target.value)}
              className="name-input"
            />
          </div>

          <div className="input-group">
            <label>名字长度</label>
            <div className="length-buttons">
              <button
                className={`length-btn ${nameLength === 'any' ? 'active' : ''}`}
                onClick={() => setNameLength('any')}
              >
                任意
              </button>
              {surname.length <= 1 && (
                <button
                  className={`length-btn ${nameLength === '2' ? 'active' : ''}`}
                  onClick={() => setNameLength('2')}
                >
                  两个字
                </button>
              )}
              <button
                className={`length-btn ${nameLength === '3' ? 'active' : ''}`}
                onClick={() => setNameLength('3')}
                disabled={surname.length > 1 && nameLength === '2'}
              >
                三个字
              </button>
              <button
                className={`length-btn ${nameLength === '4' ? 'active' : ''}`}
                onClick={() => setNameLength('4')}
              >
                四个字
              </button>
            </div>
            {surname.length > 1 && (
              <p style={{ fontSize: '0.85rem', color: 'var(--color-text-secondary)', marginTop: '0.5rem' }}>
                复姓从三个字开始
              </p>
            )}
          </div>

          <div className="input-group">
            <label>个人偏好（可多选）</label>
            <div className="preference-tags">
              {preferenceOptions.map(pref => (
                <button
                  key={pref}
                  className={`preference-tag ${preferences.includes(pref) ? 'active' : ''}`}
                  onClick={() => togglePreference(pref)}
                >
                  {pref}
                </button>
              ))}
            </div>
          </div>

          <button
            className="generate-btn"
            onClick={generateNames}
            disabled={!surname.trim() || isGenerating}
          >
            {isGenerating ? '生成中...' : '🤖 智能生成名字'}
          </button>
        </div>

        {generatedNames.length > 0 && (
          <div className="results-section">
            <h2>为您推荐的名字</h2>
            <div className="names-grid">
              {generatedNames.map((name, index) => (
                <div key={index} className="name-card">
                  <div className="name-text">{name}</div>
                  <button
                    className="copy-btn"
                    onClick={() => copyName(name)}
                    title="复制"
                  >
                    📋
                  </button>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  )
}

export default NameGenerator

