import { useState } from 'react'
import './BaziFortune.css'

interface BaziFortuneProps {
  onBack?: () => void
}

// å¤©å¹²åœ°æ”¯
const tiangan = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸']
const dizhi = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']

// å¤©å¹²å¯¹åº”çš„äº”è¡Œ
const tianganWuxing: { [key: string]: string } = {
  'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ',
  'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´'
}

// åœ°æ”¯å¯¹åº”çš„äº”è¡Œ
const dizhiWuxing: { [key: string]: string } = {
  'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'è¾°': 'åœŸ', 'å·³': 'ç«',
  'åˆ': 'ç«', 'æœª': 'åœŸ', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
}

// åç¥å…³ç³»
const shishenMap: { [key: string]: { [key: string]: string } } = {
  'ç”²': { 'ç”²': 'æ¯”è‚©', 'ä¹™': 'åŠ«è´¢', 'ä¸™': 'é£Ÿç¥', 'ä¸': 'ä¼¤å®˜', 'æˆŠ': 'åè´¢', 'å·±': 'æ­£è´¢', 'åºš': 'ä¸ƒæ€', 'è¾›': 'æ­£å®˜', 'å£¬': 'åå°', 'ç™¸': 'æ­£å°' },
  'ä¹™': { 'ç”²': 'åŠ«è´¢', 'ä¹™': 'æ¯”è‚©', 'ä¸™': 'ä¼¤å®˜', 'ä¸': 'é£Ÿç¥', 'æˆŠ': 'æ­£è´¢', 'å·±': 'åè´¢', 'åºš': 'æ­£å®˜', 'è¾›': 'ä¸ƒæ€', 'å£¬': 'æ­£å°', 'ç™¸': 'åå°' },
  'ä¸™': { 'ç”²': 'åå°', 'ä¹™': 'æ­£å°', 'ä¸™': 'æ¯”è‚©', 'ä¸': 'åŠ«è´¢', 'æˆŠ': 'é£Ÿç¥', 'å·±': 'ä¼¤å®˜', 'åºš': 'åè´¢', 'è¾›': 'æ­£è´¢', 'å£¬': 'ä¸ƒæ€', 'ç™¸': 'æ­£å®˜' },
  'ä¸': { 'ç”²': 'æ­£å°', 'ä¹™': 'åå°', 'ä¸™': 'åŠ«è´¢', 'ä¸': 'æ¯”è‚©', 'æˆŠ': 'ä¼¤å®˜', 'å·±': 'é£Ÿç¥', 'åºš': 'æ­£è´¢', 'è¾›': 'åè´¢', 'å£¬': 'æ­£å®˜', 'ç™¸': 'ä¸ƒæ€' },
  'æˆŠ': { 'ç”²': 'ä¸ƒæ€', 'ä¹™': 'æ­£å®˜', 'ä¸™': 'åå°', 'ä¸': 'æ­£å°', 'æˆŠ': 'æ¯”è‚©', 'å·±': 'åŠ«è´¢', 'åºš': 'é£Ÿç¥', 'è¾›': 'ä¼¤å®˜', 'å£¬': 'åè´¢', 'ç™¸': 'æ­£è´¢' },
  'å·±': { 'ç”²': 'æ­£å®˜', 'ä¹™': 'ä¸ƒæ€', 'ä¸™': 'æ­£å°', 'ä¸': 'åå°', 'æˆŠ': 'åŠ«è´¢', 'å·±': 'æ¯”è‚©', 'åºš': 'ä¼¤å®˜', 'è¾›': 'é£Ÿç¥', 'å£¬': 'æ­£è´¢', 'ç™¸': 'åè´¢' },
  'åºš': { 'ç”²': 'åè´¢', 'ä¹™': 'æ­£è´¢', 'ä¸™': 'ä¸ƒæ€', 'ä¸': 'æ­£å®˜', 'æˆŠ': 'åå°', 'å·±': 'æ­£å°', 'åºš': 'æ¯”è‚©', 'è¾›': 'åŠ«è´¢', 'å£¬': 'é£Ÿç¥', 'ç™¸': 'ä¼¤å®˜' },
  'è¾›': { 'ç”²': 'æ­£è´¢', 'ä¹™': 'åè´¢', 'ä¸™': 'æ­£å®˜', 'ä¸': 'ä¸ƒæ€', 'æˆŠ': 'æ­£å°', 'å·±': 'åå°', 'åºš': 'åŠ«è´¢', 'è¾›': 'æ¯”è‚©', 'å£¬': 'ä¼¤å®˜', 'ç™¸': 'é£Ÿç¥' },
  'å£¬': { 'ç”²': 'é£Ÿç¥', 'ä¹™': 'ä¼¤å®˜', 'ä¸™': 'åè´¢', 'ä¸': 'æ­£è´¢', 'æˆŠ': 'ä¸ƒæ€', 'å·±': 'æ­£å®˜', 'åºš': 'åå°', 'è¾›': 'æ­£å°', 'å£¬': 'æ¯”è‚©', 'ç™¸': 'åŠ«è´¢' },
  'ç™¸': { 'ç”²': 'ä¼¤å®˜', 'ä¹™': 'é£Ÿç¥', 'ä¸™': 'æ­£è´¢', 'ä¸': 'åè´¢', 'æˆŠ': 'æ­£å®˜', 'å·±': 'ä¸ƒæ€', 'åºš': 'æ­£å°', 'è¾›': 'åå°', 'å£¬': 'åŠ«è´¢', 'ç™¸': 'æ¯”è‚©' }
}

// ç²¾ç¡®è®¡ç®—èŠ‚æ°”çš„æ—¥æœŸ
const getSolarTermDate = (year: number, termIndex: number): Date => {
  const solarLongitude = [315, 330, 345, 0, 15, 30, 45, 60, 75, 90, 105, 120]
  const targetLongitude = solarLongitude[termIndex]
  const springEquinox = new Date(year, 2, 20)
  const daysFromEquinox = (targetLongitude - 0 + 360) % 360
  const days = Math.round(daysFromEquinox * 365.2422 / 360)
  const termDate = new Date(springEquinox)
  termDate.setDate(termDate.getDate() + days)
  return termDate
}

// è®¡ç®—ç«‹æ˜¥æ—¥æœŸ
const getLichunDate = (year: number): Date => {
  return getSolarTermDate(year, 0)
}

// è®¡ç®—å¹´æŸ±
const calculateYearPillar = (date: Date): string => {
  const year = date.getFullYear()
  const lichun = getLichunDate(year)
  const lichunNext = getLichunDate(year + 1)
  
  let actualYear = year
  if (date < lichun) {
    actualYear = year - 1
  } else if (date >= lichunNext) {
    actualYear = year + 1
  }
  
  const ganIndex = (actualYear - 4) % 10
  const zhiIndex = (actualYear - 4) % 12
  return tiangan[ganIndex] + dizhi[zhiIndex]
}

// ç²¾ç¡®è®¡ç®—èŠ‚æ°”å¯¹åº”çš„æœˆä»½
const getJieqiMonth = (year: number, month: number, day: number): number => {
  const currentDate = new Date(year, month - 1, day)
  
  // åˆ¤æ–­æ˜¯å¦åœ¨ç«‹æ˜¥ä¹‹å‰ï¼Œå¦‚æœæ˜¯åˆ™ä½¿ç”¨ä¸Šä¸€å¹´
  let actualYear = year
  const lichunThisYear = getSolarTermDate(year, 0) // ç«‹æ˜¥
  if (currentDate < lichunThisYear) {
    actualYear = year - 1
  }
  
  // è·å–å½“å‰å¹´ä»½çš„æ‰€æœ‰èŠ‚æ°”æ—¥æœŸ
  const solarTerms: Date[] = []
  for (let i = 0; i < 12; i++) {
    solarTerms.push(getSolarTermDate(actualYear, i))
  }
  // æ·»åŠ ä¸‹ä¸€å¹´çš„ç«‹æ˜¥ï¼ˆç”¨äºåˆ¤æ–­å°å¯’åçš„æ—¥æœŸï¼‰
  solarTerms.push(getSolarTermDate(actualYear + 1, 0))
  
  // åˆ¤æ–­å½“å‰æ—¥æœŸå±äºå“ªä¸ªèŠ‚æ°”æœˆ
  for (let i = 0; i < 12; i++) {
    if (currentDate >= solarTerms[i] && currentDate < solarTerms[i + 1]) {
      // è¿”å›èŠ‚æ°”æœˆï¼ˆå†œå†æœˆä»½ï¼Œä»ç«‹æ˜¥å¼€å§‹ä¸ºæ­£æœˆï¼‰
      return i + 1 // ç«‹æ˜¥ä¸ºæ­£æœˆï¼ˆ1ï¼‰ï¼ŒæƒŠè›°ä¸ºäºŒæœˆï¼ˆ2ï¼‰ï¼Œä»¥æ­¤ç±»æ¨
    }
  }
  
  // å¦‚æœåœ¨å°å¯’ä¹‹åã€ç«‹æ˜¥ä¹‹å‰ï¼Œè¿”å›12æœˆï¼ˆä¸Šä¸€å¹´ï¼‰
  return 12
}

// è®¡ç®—æœˆæŸ±
const calculateMonthPillar = (date: Date, yearPillar: string): string => {
  const year = date.getFullYear()
  const month = date.getMonth() + 1
  const day = date.getDate()
  
  // è·å–èŠ‚æ°”æœˆï¼ˆå†œå†æœˆä»½ï¼Œä»ç«‹æ˜¥å¼€å§‹ä¸ºæ­£æœˆï¼‰
  const jieqiMonth = getJieqiMonth(year, month, day)
  
  // æœˆæ”¯ï¼šæ­£æœˆä¸ºå¯…ï¼ŒäºŒæœˆä¸ºå¯ï¼Œä»¥æ­¤ç±»æ¨
  // æ­£æœˆå¯¹åº”å¯…ï¼ˆç´¢å¼•2ï¼‰ï¼Œæ‰€ä»¥ jieqiMonth=1 æ—¶ï¼Œæœˆæ”¯ç´¢å¼•åº”è¯¥æ˜¯ 2
  const monthZhiIndex = (jieqiMonth + 1) % 12
  const monthZhi = dizhi[monthZhiIndex]
  
  // æœˆå¹²ï¼šæ ¹æ®å¹´å¹²å’Œæœˆæ”¯è®¡ç®—ï¼ˆäº”è™éï¼‰
  // ç”²å·±ä¹‹å¹´ä¸™ä½œé¦–ï¼Œä¹™åºšä¹‹å¹´æˆŠä¸ºå¤´ï¼Œä¸™è¾›ä¹‹å¹´å¯»åºšèµ·ï¼Œä¸å£¬å£¬å¯…é¡ºæ°´æµï¼Œè‹¥é—®æˆŠç™¸ä½•å¤„èµ·ï¼Œç”²å¯…ä¹‹ä¸Šå¥½è¿½æ±‚
  const yearGan = yearPillar[0]
  const yearGanIndex = tiangan.indexOf(yearGan)
  
  let monthGanIndex = 0
  if (yearGanIndex === 0 || yearGanIndex === 5) { // ç”²æˆ–å·±
    monthGanIndex = (2 + jieqiMonth - 1) % 10 // ä¸™ä½œé¦–ï¼Œæ­£æœˆä¸ºä¸™
  } else if (yearGanIndex === 1 || yearGanIndex === 6) { // ä¹™æˆ–åºš
    monthGanIndex = (4 + jieqiMonth - 1) % 10 // æˆŠä¸ºå¤´
  } else if (yearGanIndex === 2 || yearGanIndex === 7) { // ä¸™æˆ–è¾›
    monthGanIndex = (6 + jieqiMonth - 1) % 10 // å¯»åºšèµ·
  } else if (yearGanIndex === 3 || yearGanIndex === 8) { // ä¸æˆ–å£¬
    monthGanIndex = (8 + jieqiMonth - 1) % 10 // å£¬å¯…é¡ºæ°´æµ
  } else { // æˆŠæˆ–ç™¸
    monthGanIndex = (0 + jieqiMonth - 1) % 10 // ç”²å¯…ä¹‹ä¸Š
  }
  
  const monthGan = tiangan[monthGanIndex]
  
  return monthGan + monthZhi
}

// è®¡ç®—æ—¥æŸ±
const calculateDayPillar = (date: Date): string => {
  const baseDate = new Date(1900, 0, 1)
  const daysDiff = Math.floor((date.getTime() - baseDate.getTime()) / (1000 * 60 * 60 * 24))
  const ganIndex = (daysDiff + 6) % 10
  const zhiIndex = (daysDiff + 8) % 12
  return tiangan[ganIndex] + dizhi[zhiIndex]
}

// è®¡ç®—æ—¶æŸ±
const calculateHourPillar = (dayPillar: string, birthTime: string): string => {
  const shichen = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
  
  const hourZhi = birthTime || 'å­'
  const hourIndex = shichen.indexOf(hourZhi)
  if (hourIndex === -1) return ''
  
  const dayGan = dayPillar[0]
  const dayGanIndex = tiangan.indexOf(dayGan)
  
  let hourGanIndex = 0
  if (dayGanIndex === 0 || dayGanIndex === 5) {
    hourGanIndex = (0 + hourIndex) % 10
  } else if (dayGanIndex === 1 || dayGanIndex === 6) {
    hourGanIndex = (2 + hourIndex) % 10
  } else if (dayGanIndex === 2 || dayGanIndex === 7) {
    hourGanIndex = (4 + hourIndex) % 10
  } else if (dayGanIndex === 3 || dayGanIndex === 8) {
    hourGanIndex = (6 + hourIndex) % 10
  } else {
    hourGanIndex = (8 + hourIndex) % 10
  }
  
  return tiangan[hourGanIndex] + hourZhi
}

// åˆ†æäº”è¡Œ
const analyzeWuxing = (bazi: string[]): { [key: string]: number } => {
  const wuxingCount: { [key: string]: number } = { 'é‡‘': 0, 'æœ¨': 0, 'æ°´': 0, 'ç«': 0, 'åœŸ': 0 }
  
  bazi.forEach(pillar => {
    if (pillar.length >= 2) {
      const gan = pillar[0]
      const zhi = pillar[1]
      if (tianganWuxing[gan]) wuxingCount[tianganWuxing[gan]]++
      if (dizhiWuxing[zhi]) wuxingCount[dizhiWuxing[zhi]]++
    }
  })
  
  return wuxingCount
}

// åˆ†æåç¥
const analyzeShishen = (bazi: string[]): string[] => {
  if (bazi.length < 4) return []
  const dayGan = bazi[2][0]
  const shishen: string[] = []
  
  bazi.forEach((pillar, index) => {
    if (index !== 2 && pillar.length >= 1) {
      const gan = pillar[0]
      const shishenName = shishenMap[dayGan]?.[gan] || ''
      if (shishenName) shishen.push(`${pillar}(${shishenName})`)
    }
  })
  
  return shishen
}

// å‘½ç†è§£è¯»
const interpretBazi = (bazi: string[], wuxing: { [key: string]: number }, shishen: string[]): {
  personality: string
  career: string
  wealth: string
  health: string
  relationship: string
  summary: string
} => {
  const dayGan = bazi[2]?.[0] || ''
  const dayWuxing = tianganWuxing[dayGan] || 'åœŸ'
  
  // æ‰¾å‡ºæœ€å¤šçš„äº”è¡Œ
  const maxWuxing = Object.entries(wuxing).reduce((a, b) => wuxing[a[0]] > wuxing[b[0]] ? a : b)[0]
  const minWuxing = Object.entries(wuxing).reduce((a, b) => wuxing[a[0]] < wuxing[b[0]] ? a : b)[0]
  
  // æ€§æ ¼åˆ†æï¼ˆæ›´ä¸°å¯Œï¼‰
  const getPersonalityAnalysis = (dayWuxing: string, wuxing: { [key: string]: number }, shishen: string[]): string => {
    const basePersonality: { [key: string]: string[] } = {
      'æœ¨': [
        'æ€§æ ¼æ¸©å’Œå–„è‰¯ï¼Œå¯Œæœ‰åŒæƒ…å¿ƒå’ŒåŒç†å¿ƒï¼Œå®¹æ˜“ä¸ä»–äººå»ºç«‹è‰¯å¥½å…³ç³»ã€‚æ€ç»´æ´»è·ƒï¼Œå¯Œæœ‰åˆ›é€ åŠ›å’Œæƒ³è±¡åŠ›ï¼Œå–œæ¬¢æ¢ç´¢æ–°äº‹ç‰©ã€‚',
        'æ€§æ ¼å¼€æœ—ä¹è§‚ï¼Œå–œæ¬¢è‡ªç”±è‡ªåœ¨çš„ç”Ÿæ´»ï¼Œä¸å–œæ¬¢è¢«æŸç¼šå’Œé™åˆ¶ã€‚æœ‰é¢†å¯¼æ‰èƒ½å’Œç»„ç»‡èƒ½åŠ›ï¼Œå–„äºåè°ƒå›¢é˜Ÿå…³ç³»ã€‚',
        'æ€§æ ¼åšéŸ§ä¸æ‹”ï¼Œé¢å¯¹å›°éš¾ä¸è½»æ˜“æ”¾å¼ƒï¼Œæœ‰å¼ºçƒˆçš„è´£ä»»æ„Ÿå’Œä½¿å‘½æ„Ÿã€‚å–œæ¬¢å­¦ä¹ å’Œæˆé•¿ï¼Œè¿½æ±‚ç²¾ç¥å±‚é¢çš„æ»¡è¶³ã€‚',
        'æ€§æ ¼æ¸©å’Œä½†å†…å¿ƒåšå®šï¼Œæœ‰è‡ªå·±çš„åŸåˆ™å’Œåº•çº¿ã€‚å–„äºå€¾å¬ä»–äººï¼Œæ˜¯å¾ˆå¥½çš„æœ‹å‹å’Œä¼™ä¼´ã€‚',
        'æ€§æ ¼çµæ´»å˜é€šï¼Œé€‚åº”èƒ½åŠ›å¼ºï¼Œèƒ½å¤Ÿå¿«é€Ÿèå…¥æ–°ç¯å¢ƒã€‚æœ‰è‰ºæœ¯å¤©èµ‹ï¼Œå¯¹ç¾çš„äº‹ç‰©æœ‰æ•é”çš„æ„ŸçŸ¥åŠ›ã€‚'
      ],
      'ç«': [
        'æ€§æ ¼çƒ­æƒ…å¼€æœ—ï¼Œå……æ»¡æ´»åŠ›å’Œæ­£èƒ½é‡ï¼Œæ˜¯äººç¾¤ä¸­çš„ç„¦ç‚¹ã€‚è¡ŒåŠ¨åŠ›å¼ºï¼Œåšäº‹æœæ–­è¿…é€Ÿï¼Œä¸å–œæ¬¢æ‹–æ³¥å¸¦æ°´ã€‚',
        'æ€§æ ¼å¤–å‘æ´»æ³¼ï¼Œå–œæ¬¢ç¤¾äº¤å’Œä¸äººäº¤æµï¼Œäººç¼˜å¾ˆå¥½ã€‚æœ‰é¢†å¯¼é­…åŠ›ï¼Œèƒ½å¤Ÿæ¿€åŠ±å’Œå¸¦åŠ¨ä»–äººã€‚',
        'æ€§æ ¼æ€¥èºä½†çœŸè¯šï¼Œè¯´è¯ç›´æ¥ï¼Œä¸å–œæ¬¢æ‹å¼¯æŠ¹è§’ã€‚æœ‰å¼ºçƒˆçš„æ­£ä¹‰æ„Ÿï¼Œè§ä¸å¾—ä¸å…¬å¹³çš„äº‹æƒ…ã€‚',
        'æ€§æ ¼ä¹è§‚å‘ä¸Šï¼Œé¢å¯¹æŒ«æŠ˜èƒ½å¤Ÿå¿«é€Ÿè°ƒæ•´å¿ƒæ€ã€‚æœ‰è¡¨æ¼”å¤©èµ‹ï¼Œå–œæ¬¢å±•ç¤ºè‡ªå·±ï¼Œäº«å—è¢«å…³æ³¨çš„æ„Ÿè§‰ã€‚',
        'æ€§æ ¼çƒ­æƒ…ä½†æœ‰æ—¶ç¼ºä¹è€å¿ƒï¼Œéœ€è¦å­¦ä¼šæ§åˆ¶æƒ…ç»ªã€‚æœ‰å¾ˆå¼ºçš„æ‰§è¡ŒåŠ›å’Œå†³æ–­åŠ›ï¼Œé€‚åˆåšå†³ç­–è€…ã€‚'
      ],
      'åœŸ': [
        'æ€§æ ¼ç¨³é‡è¸å®ï¼Œå€¼å¾—ä¿¡èµ–ï¼Œæ˜¯æœ‹å‹å’ŒåŒäº‹çœ¼ä¸­çš„å¯é ä¹‹äººã€‚åšäº‹è®¤çœŸè´Ÿè´£ï¼Œæœ‰å¼ºçƒˆçš„è´£ä»»å¿ƒå’Œä½¿å‘½æ„Ÿã€‚',
        'æ€§æ ¼æ¸©å’ŒåŒ…å®¹ï¼Œä¸å–œäº‰æ‰§ï¼Œå–„äºåŒ–è§£çŸ›ç›¾ã€‚æœ‰å¾ˆå¼ºçš„è€å¿ƒå’Œæ¯…åŠ›ï¼Œèƒ½å¤ŸåšæŒå®Œæˆé•¿æœŸç›®æ ‡ã€‚',
        'æ€§æ ¼ä¿å®ˆä½†åŠ¡å®ï¼Œä¸å–œæ¬¢å†’é™©ï¼Œæ›´å€¾å‘äºç¨³å¥çš„å‘å±•ã€‚æœ‰ç†è´¢å¤©èµ‹ï¼Œå–„äºç§¯ç´¯è´¢å¯Œã€‚',
        'æ€§æ ¼å›ºæ‰§ä½†å¿ è¯šï¼Œä¸€æ—¦è®¤å®šçš„äº‹æƒ…ä¸ä¼šè½»æ˜“æ”¹å˜ã€‚æœ‰å¾ˆå¼ºçš„ç»„ç»‡èƒ½åŠ›å’Œç®¡ç†æ‰èƒ½ã€‚',
        'æ€§æ ¼å†…æ•›ä½†å†…å¿ƒä¸°å¯Œï¼Œä¸å–„äºè¡¨è¾¾ä½†æƒ…æ„Ÿç»†è…»ã€‚æœ‰å¾ˆå¼ºçš„å­¦ä¹ èƒ½åŠ›å’Œé€‚åº”èƒ½åŠ›ã€‚'
      ],
      'é‡‘': [
        'æ€§æ ¼åˆšå¼ºåšæ¯…ï¼Œæ„å¿—åšå®šï¼Œç›®æ ‡æ˜ç¡®ï¼Œä¸è¾¾ç›®çš„ä¸ç½¢ä¼‘ã€‚åšäº‹æœ‰æ¡ç†ï¼Œæ‰§è¡ŒåŠ›å¼ºï¼Œæ•ˆç‡å¾ˆé«˜ã€‚',
        'æ€§æ ¼ä¸¥è‚ƒè®¤çœŸï¼Œå¯¹è‡ªå·±å’Œä»–äººè¦æ±‚éƒ½å¾ˆé«˜ã€‚æœ‰å¾ˆå¼ºçš„åŸåˆ™æ€§ï¼Œä¸ä¼šè½»æ˜“å¦¥åã€‚',
        'æ€§æ ¼å†·é™ç†æ€§ï¼Œå–„äºåˆ†æå’Œæ€è€ƒï¼Œèƒ½å¤Ÿå®¢è§‚çœ‹å¾…é—®é¢˜ã€‚æœ‰å¾ˆå¼ºçš„é€»è¾‘æ€ç»´èƒ½åŠ›å’Œåˆ¤æ–­åŠ›ã€‚',
        'æ€§æ ¼ç‹¬ç«‹è‡ªä¸»ï¼Œä¸å–œæ¬¢ä¾èµ–ä»–äººï¼Œæœ‰å¾ˆå¼ºçš„è‡ªæˆ‘ç®¡ç†èƒ½åŠ›ã€‚æœ‰æŠ€æœ¯å¤©èµ‹ï¼Œé€‚åˆåšä¸“ä¸šæŠ€æœ¯äººå‘˜ã€‚',
        'æ€§æ ¼æœæ–­å†³ç»ï¼Œé¢å¯¹é€‰æ‹©èƒ½å¤Ÿå¿«é€Ÿåšå‡ºå†³å®šã€‚æœ‰å¾ˆå¼ºçš„ç»„ç»‡èƒ½åŠ›å’Œé¢†å¯¼æ‰èƒ½ï¼Œä½†æœ‰æ—¶è¿‡äºä¸¥å‰ã€‚'
      ],
      'æ°´': [
        'æ€§æ ¼èªæ˜çµæ´»ï¼Œé€‚åº”åŠ›å¼ºï¼Œèƒ½å¤Ÿå¿«é€Ÿåº”å¯¹å„ç§å˜åŒ–ã€‚æ€ç»´æ•æ·ï¼Œå–„äºæ€è€ƒå’Œæ€»ç»“ï¼Œæœ‰å¾ˆå¼ºçš„å­¦ä¹ èƒ½åŠ›ã€‚',
        'æ€§æ ¼æ¸©å’Œå–„è‰¯ï¼Œå–„äºæ²Ÿé€šå’Œåè°ƒï¼Œæ˜¯å¾ˆå¥½çš„å€¾å¬è€…å’Œè°ƒè§£è€…ã€‚æœ‰å¾ˆå¼ºçš„åŒç†å¿ƒï¼Œèƒ½å¤Ÿç†è§£ä»–äººçš„æ„Ÿå—ã€‚',
        'æ€§æ ¼çµæ´»å˜é€šï¼Œä¸å–œæ¬¢ä¸€æˆä¸å˜çš„ç”Ÿæ´»ã€‚æœ‰å¾ˆå¼ºçš„åˆ›é€ åŠ›å’Œæƒ³è±¡åŠ›ï¼Œé€‚åˆä»äº‹åˆ›æ„å·¥ä½œã€‚',
        'æ€§æ ¼æƒ…ç»ªåŒ–ä½†çœŸè¯šï¼Œæƒ…æ„Ÿä¸°å¯Œï¼Œå¯¹æ„Ÿæƒ…å¾ˆé‡è§†ã€‚æœ‰å¾ˆå¼ºçš„ç›´è§‰å’Œæ´å¯ŸåŠ›ï¼Œèƒ½å¤Ÿçœ‹é€äº‹ç‰©çš„æœ¬è´¨ã€‚',
        'æ€§æ ¼æ¸©å’Œä½†å†…å¿ƒåšå¼ºï¼Œé¢å¯¹å›°éš¾èƒ½å¤Ÿä¿æŒå†·é™ã€‚æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›å’Œåº”å˜èƒ½åŠ›ï¼Œèƒ½å¤Ÿåœ¨é€†å¢ƒä¸­æˆé•¿ã€‚'
      ]
    }
    
    // æ ¹æ®äº”è¡Œå¼ºå¼±è°ƒæ•´
    const wuxingStrength = wuxing[dayWuxing] || 0
    const isStrong = wuxingStrength >= 3
    const isWeak = wuxingStrength <= 1
    
    let personality = basePersonality[dayWuxing]?.[Math.floor(Math.random() * basePersonality[dayWuxing].length)] || ''
    
    if (isStrong) {
      personality += ' æ‚¨çš„æ—¥ä¸»äº”è¡Œè¾ƒæ—ºï¼Œæ€§æ ¼ç‰¹ç‚¹ä¼šæ›´åŠ æ˜æ˜¾ï¼Œä½†éœ€è¦æ³¨æ„ä¸è¦è¿‡äºå¼ºåŠ¿ï¼Œå­¦ä¼šå€¾å¬å’ŒåŒ…å®¹ã€‚'
    } else if (isWeak) {
      personality += ' æ‚¨çš„æ—¥ä¸»äº”è¡Œè¾ƒå¼±ï¼Œæ€§æ ¼å¯èƒ½è¾ƒä¸ºå†…æ•›ï¼Œéœ€è¦å¢å¼ºè‡ªä¿¡ï¼Œä¸»åŠ¨è¡¨è¾¾è‡ªå·±çš„æƒ³æ³•å’Œéœ€æ±‚ã€‚'
    }
    
    // æ ¹æ®åç¥è°ƒæ•´
    if (shishen.some(s => s.includes('æ­£å®˜'))) {
      personality += ' å‘½ä¸­æœ‰æ­£å®˜ï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„è´£ä»»æ„Ÿå’Œæ­£ä¹‰æ„Ÿï¼Œåšäº‹æœ‰åŸåˆ™ï¼Œå®¹æ˜“å¾—åˆ°ä»–äººçš„å°Šé‡å’Œä¿¡ä»»ã€‚'
    }
    if (shishen.some(s => s.includes('æ­£å°'))) {
      personality += ' å‘½ä¸­æœ‰æ­£å°ï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„å­¦ä¹ èƒ½åŠ›å’Œæ™ºæ…§ï¼Œå–œæ¬¢æ€è€ƒï¼Œæœ‰å¾ˆå¥½çš„æ–‡åŒ–ä¿®å…»ã€‚'
    }
    if (shishen.some(s => s.includes('é£Ÿç¥'))) {
      personality += ' å‘½ä¸­æœ‰é£Ÿç¥ï¼Œæ‚¨æ€§æ ¼æ¸©å’Œï¼Œæœ‰è‰ºæœ¯å¤©èµ‹ï¼Œå–œæ¬¢äº«å—ç”Ÿæ´»ï¼Œäººç¼˜å¾ˆå¥½ã€‚'
    }
    
    return personality || 'æ€§æ ¼ç‰¹ç‚¹éœ€è¦ç»¼åˆåˆ†æ'
  }
  
  const personality = getPersonalityAnalysis(dayWuxing, wuxing, shishen)
  
  // äº‹ä¸šåˆ†æï¼ˆæ›´ä¸°å¯Œï¼‰
  const getCareerAnalysis = (dayWuxing: string, _wuxing: { [key: string]: number }, shishen: string[]): string => {
    const baseCareer: { [key: string]: string[] } = {
      'æœ¨': [
        'é€‚åˆä»äº‹æ•™è‚²ã€æ–‡åŒ–ã€è‰ºæœ¯ã€å‡ºç‰ˆã€ä¼ åª’ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è¡¨è¾¾èƒ½åŠ›å’Œæ„ŸæŸ“åŠ›ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°ä¼ é€’çŸ¥è¯†å’Œç†å¿µã€‚',
        'é€‚åˆä»äº‹ç®¡ç†ã€ç»„ç»‡ã€äººåŠ›èµ„æºç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„é¢†å¯¼æ‰èƒ½å’Œç»„ç»‡èƒ½åŠ›ï¼Œå–„äºåè°ƒå›¢é˜Ÿå…³ç³»ï¼Œèƒ½å¤Ÿå¸¦é¢†å›¢é˜Ÿè¾¾æˆç›®æ ‡ã€‚',
        'é€‚åˆåˆ›ä¸šï¼Œç‰¹åˆ«æ˜¯æ–‡åŒ–åˆ›æ„ã€æ•™è‚²åŸ¹è®­ã€å’¨è¯¢æœåŠ¡ç­‰é¢†åŸŸã€‚æ‚¨æœ‰å¼€æ‹“ç²¾ç¥å’Œåˆ›æ–°æ€ç»´ï¼Œèƒ½å¤Ÿå‘ç°å’ŒæŠŠæ¡å¸‚åœºæœºä¼šã€‚',
        'é€‚åˆä»äº‹è®¾è®¡ã€ç­–åˆ’ã€å’¨è¯¢ç­‰éœ€è¦åˆ›æ„å’Œæ€è€ƒçš„å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æƒ³è±¡åŠ›å’Œåˆ›é€ åŠ›ï¼Œèƒ½å¤Ÿæå‡ºç‹¬ç‰¹çš„è§£å†³æ–¹æ¡ˆã€‚',
        'é€‚åˆä»äº‹åŒ»ç–—ã€å¥åº·ã€å…»ç”Ÿç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„åŒç†å¿ƒå’Œè´£ä»»æ„Ÿï¼Œèƒ½å¤Ÿå¸®åŠ©ä»–äººæ”¹å–„ç”Ÿæ´»è´¨é‡ã€‚'
      ],
      'ç«': [
        'é€‚åˆä»äº‹é”€å”®ã€è¥é”€ã€å…¬å…³ã€å¹¿å‘Šç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æ²Ÿé€šèƒ½åŠ›å’Œè¯´æœåŠ›ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°æ¨å¹¿äº§å“å’ŒæœåŠ¡ã€‚',
        'é€‚åˆä»äº‹é¢†å¯¼ã€ç®¡ç†ã€åˆ›ä¸šç­‰å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„é¢†å¯¼é­…åŠ›å’Œæ‰§è¡ŒåŠ›ï¼Œèƒ½å¤Ÿæ¿€åŠ±å›¢é˜Ÿï¼Œæ¨åŠ¨äº‹ä¸šå‘å±•ã€‚',
        'é€‚åˆä»äº‹ä¼ åª’ã€å¨±ä¹ã€è¡¨æ¼”ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è¡¨ç°åŠ›å’Œæ„ŸæŸ“åŠ›ï¼Œèƒ½å¤Ÿå¸å¼•å’Œå½±å“ä»–äººã€‚',
        'é€‚åˆä»äº‹é¤é¥®ã€æ—…æ¸¸ã€æœåŠ¡ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æœåŠ¡æ„è¯†å’Œçƒ­æƒ…ï¼Œèƒ½å¤Ÿä¸ºä»–äººæä¾›ä¼˜è´¨çš„æœåŠ¡ä½“éªŒã€‚',
        'é€‚åˆä»äº‹äº’è”ç½‘ã€ç§‘æŠ€ã€åˆ›æ–°ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è¡ŒåŠ¨åŠ›å’Œåˆ›æ–°ç²¾ç¥ï¼Œèƒ½å¤Ÿå¿«é€Ÿé€‚åº”æ–°æŠ€æœ¯å’Œæ–°è¶‹åŠ¿ã€‚'
      ],
      'åœŸ': [
        'é€‚åˆä»äº‹é‡‘èã€æŠ•èµ„ã€æˆ¿åœ°äº§ã€å»ºç­‘ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ç†è´¢èƒ½åŠ›å’Œé£é™©æ§åˆ¶æ„è¯†ï¼Œèƒ½å¤Ÿç¨³å¥åœ°ç§¯ç´¯è´¢å¯Œã€‚',
        'é€‚åˆä»äº‹ç¨³å®šã€ä¼ ç»Ÿçš„è¡Œä¸šï¼Œå¦‚åˆ¶é€ ä¸šã€å†œä¸šã€ç‰©æµç­‰ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æ‰§è¡ŒåŠ›å’Œç¨³å®šæ€§ï¼Œèƒ½å¤Ÿé•¿æœŸåšæŒåšå¥½ä¸€ä»¶äº‹ã€‚',
        'é€‚åˆä»äº‹ç®¡ç†ã€è¡Œæ”¿ã€äººåŠ›èµ„æºç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ç»„ç»‡èƒ½åŠ›å’Œåè°ƒèƒ½åŠ›ï¼Œèƒ½å¤Ÿç»´æŠ¤å›¢é˜Ÿçš„ç¨³å®šå’Œå’Œè°ã€‚',
        'é€‚åˆä»äº‹å’¨è¯¢ã€è§„åˆ’ã€è®¾è®¡ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„åˆ†æèƒ½åŠ›å’Œè§„åˆ’èƒ½åŠ›ï¼Œèƒ½å¤Ÿåˆ¶å®šé•¿æœŸçš„å‘å±•æˆ˜ç•¥ã€‚',
        'é€‚åˆä»äº‹æ•™è‚²ã€åŸ¹è®­ã€æ–‡åŒ–ä¼ æ‰¿ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è´£ä»»æ„Ÿå’Œä½¿å‘½æ„Ÿï¼Œèƒ½å¤Ÿä¼ æ‰¿å’Œå‘æ‰¬ä¼˜ç§€çš„æ–‡åŒ–ä¼ ç»Ÿã€‚'
      ],
      'é‡‘': [
        'é€‚åˆä»äº‹æŠ€æœ¯ã€å·¥ç¨‹ã€åˆ¶é€ ã€ç ”å‘ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„é€»è¾‘æ€ç»´èƒ½åŠ›å’ŒæŠ€æœ¯èƒ½åŠ›ï¼Œèƒ½å¤Ÿè§£å†³å¤æ‚çš„æŠ€æœ¯é—®é¢˜ã€‚',
        'é€‚åˆä»äº‹é‡‘èã€æŠ•èµ„ã€ä¼šè®¡ã€å®¡è®¡ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„åˆ†æèƒ½åŠ›å’Œé£é™©æ§åˆ¶èƒ½åŠ›ï¼Œèƒ½å¤Ÿåšå‡ºå‡†ç¡®çš„åˆ¤æ–­å’Œå†³ç­–ã€‚',
        'é€‚åˆä»äº‹æ³•å¾‹ã€æ‰§æ³•ã€å®‰å…¨ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„åŸåˆ™æ€§å’Œæ­£ä¹‰æ„Ÿï¼Œèƒ½å¤Ÿç»´æŠ¤å…¬å¹³å’Œæ­£ä¹‰ã€‚',
        'é€‚åˆä»äº‹ç®¡ç†ã€ç›‘ç£ã€è´¨é‡æ§åˆ¶ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æ‰§è¡ŒåŠ›å’Œç›‘ç£èƒ½åŠ›ï¼Œèƒ½å¤Ÿç¡®ä¿å·¥ä½œçš„é«˜è´¨é‡å®Œæˆã€‚',
        'é€‚åˆä»äº‹ä¸“ä¸šæŠ€æœ¯äººå‘˜ï¼Œå¦‚åŒ»ç”Ÿã€å·¥ç¨‹å¸ˆã€ç§‘å­¦å®¶ç­‰ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ä¸“ä¸šèƒ½åŠ›å’Œé’»ç ”ç²¾ç¥ï¼Œèƒ½å¤Ÿåœ¨ä¸“ä¸šé¢†åŸŸå–å¾—æˆå°±ã€‚'
      ],
      'æ°´': [
        'é€‚åˆä»äº‹è´¸æ˜“ã€ç‰©æµã€è¿è¾“ã€ä¾›åº”é“¾ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„åè°ƒèƒ½åŠ›å’Œåº”å˜èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¤„ç†å¤æ‚çš„ä¸šåŠ¡å…³ç³»ã€‚',
        'é€‚åˆä»äº‹å’¨è¯¢ã€ç­–åˆ’ã€åˆ†æç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æ€ç»´èƒ½åŠ›å’Œåˆ†æèƒ½åŠ›ï¼Œèƒ½å¤Ÿæä¾›ä¸“ä¸šçš„å»ºè®®å’Œæ–¹æ¡ˆã€‚',
        'é€‚åˆä»äº‹äº’è”ç½‘ã€ç”µå•†ã€æ–°åª’ä½“ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›å’Œåˆ›æ–°èƒ½åŠ›ï¼Œèƒ½å¤Ÿå¿«é€ŸæŠŠæ¡å¸‚åœºè¶‹åŠ¿ã€‚',
        'é€‚åˆä»äº‹æœåŠ¡ã€é”€å”®ã€å®¢æœç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æ²Ÿé€šèƒ½åŠ›å’ŒæœåŠ¡æ„è¯†ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°æ»¡è¶³å®¢æˆ·éœ€æ±‚ã€‚',
        'é€‚åˆä»äº‹åˆ›æ„ã€è®¾è®¡ã€è‰ºæœ¯ç­‰ç›¸å…³å·¥ä½œã€‚æ‚¨æœ‰å¾ˆå¼ºçš„æƒ³è±¡åŠ›å’Œåˆ›é€ åŠ›ï¼Œèƒ½å¤Ÿåˆ›é€ å‡ºç‹¬ç‰¹çš„ä½œå“å’Œæ–¹æ¡ˆã€‚'
      ]
    }
    
    let career = baseCareer[dayWuxing]?.[Math.floor(Math.random() * baseCareer[dayWuxing].length)] || ''
    
    // æ ¹æ®åç¥è°ƒæ•´
    if (shishen.some(s => s.includes('æ­£å®˜'))) {
      career += ' å‘½ä¸­æœ‰æ­£å®˜ï¼Œæ‚¨é€‚åˆåœ¨ä½“åˆ¶å†…æˆ–å¤§å‹ä¼ä¸šå·¥ä½œï¼Œæœ‰å¾ˆå¥½çš„æ™‹å‡æœºä¼šï¼Œå®¹æ˜“è·å¾—æƒå¨å’Œåœ°ä½ã€‚'
    }
    if (shishen.some(s => s.includes('åå®˜') || s.includes('ä¸ƒæ€'))) {
      career += ' å‘½ä¸­æœ‰ä¸ƒæ€ï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„ç«äº‰æ„è¯†å’Œå†’é™©ç²¾ç¥ï¼Œé€‚åˆåˆ›ä¸šæˆ–åœ¨ç«äº‰æ¿€çƒˆçš„è¡Œä¸šå·¥ä½œï¼Œèƒ½å¤Ÿåº”å¯¹æŒ‘æˆ˜ã€‚'
    }
    if (shishen.some(s => s.includes('æ­£è´¢'))) {
      career += ' å‘½ä¸­æœ‰æ­£è´¢ï¼Œæ‚¨æœ‰ç¨³å®šçš„æ”¶å…¥æ¥æºï¼Œé€‚åˆä»äº‹ä¼ ç»Ÿã€ç¨³å®šçš„å·¥ä½œï¼Œèƒ½å¤Ÿé€šè¿‡åŠªåŠ›è·å¾—è´¢å¯Œã€‚'
    }
    if (shishen.some(s => s.includes('åè´¢'))) {
      career += ' å‘½ä¸­æœ‰åè´¢ï¼Œæ‚¨æœ‰å¾ˆå¥½çš„æŠ•èµ„å’Œç†è´¢èƒ½åŠ›ï¼Œé€‚åˆä»äº‹é‡‘èã€æŠ•èµ„ç­‰å·¥ä½œï¼Œèƒ½å¤Ÿé€šè¿‡æŠ•èµ„è·å¾—é¢å¤–æ”¶å…¥ã€‚'
    }
    if (shishen.some(s => s.includes('é£Ÿç¥'))) {
      career += ' å‘½ä¸­æœ‰é£Ÿç¥ï¼Œæ‚¨æœ‰è‰ºæœ¯å¤©èµ‹å’Œåˆ›é€ åŠ›ï¼Œé€‚åˆä»äº‹æ–‡åŒ–ã€è‰ºæœ¯ã€åˆ›æ„ç­‰ç›¸å…³å·¥ä½œï¼Œèƒ½å¤Ÿå‘æŒ¥è‡ªå·±çš„æ‰åã€‚'
    }
    if (shishen.some(s => s.includes('ä¼¤å®˜'))) {
      career += ' å‘½ä¸­æœ‰ä¼¤å®˜ï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„è¡¨è¾¾èƒ½åŠ›å’Œåˆ›æ–°èƒ½åŠ›ï¼Œé€‚åˆä»äº‹ä¼ åª’ã€è®¾è®¡ã€æŠ€æœ¯ç­‰ç›¸å…³å·¥ä½œï¼Œèƒ½å¤Ÿå±•ç°è‡ªå·±çš„æ‰åã€‚'
    }
    
    return career || 'äº‹ä¸šå‘å±•éœ€è¦ç»“åˆå®é™…æƒ…å†µ'
  }
  
  const career = getCareerAnalysis(dayWuxing, wuxing, shishen)
  
  // è´¢è¿åˆ†æï¼ˆæ›´ä¸°å¯Œï¼‰
  const getWealthAnalysis = (maxWuxing: string, _minWuxing: string, wuxing: { [key: string]: number }, shishen: string[]): string => {
    let wealthText = ''
    
    // åŸºç¡€è´¢è¿åˆ†æ
    if (maxWuxing === 'é‡‘' || maxWuxing === 'åœŸ') {
      wealthText = 'æ‚¨çš„è´¢è¿è¾ƒå¥½ï¼Œæœ‰å¾ˆå¼ºçš„ç†è´¢å¤©èµ‹å’Œç§¯ç´¯è´¢å¯Œçš„èƒ½åŠ›ã€‚é€‚åˆç¨³å¥æŠ•èµ„ï¼Œå¦‚æˆ¿åœ°äº§ã€é‡‘èäº§å“ç­‰ã€‚'
      wealthText += ' æ‚¨å¯¹é‡‘é’±æœ‰å¾ˆå¥½çš„æ•æ„Ÿåº¦ï¼Œèƒ½å¤Ÿå‘ç°å’ŒæŠŠæ¡æŠ•èµ„æœºä¼šã€‚å»ºè®®åˆ¶å®šé•¿æœŸçš„ç†è´¢è®¡åˆ’ï¼Œé€šè¿‡ç¨³å¥çš„æ–¹å¼ç§¯ç´¯è´¢å¯Œã€‚'
    } else if (maxWuxing === 'ç«') {
      wealthText = 'æ‚¨çš„è´¢è¿èµ·ä¼è¾ƒå¤§ï¼Œæœ‰å¾ˆå¼ºçš„èµšé’±èƒ½åŠ›ï¼Œä½†èŠ±é’±ä¹Ÿæ¯”è¾ƒå¿«ã€‚é€‚åˆç§¯æè¿›å–çš„æŠ•èµ„æ–¹å¼ï¼Œä½†éœ€è¦è°¨æ…æ§åˆ¶é£é™©ã€‚'
      wealthText += ' æ‚¨æœ‰å¾ˆå¼ºçš„å•†ä¸šå¤´è„‘å’Œæ‰§è¡ŒåŠ›ï¼Œé€‚åˆåˆ›ä¸šæˆ–æŠ•èµ„é«˜é£é™©é«˜å›æŠ¥çš„é¡¹ç›®ã€‚å»ºè®®åšå¥½é£é™©æ§åˆ¶ï¼Œé¿å…è¿‡åº¦æŠ•èµ„ã€‚'
    } else if (maxWuxing === 'æ°´') {
      wealthText = 'æ‚¨çš„è´¢è¿å¹³ç¨³ï¼Œæœ‰å¾ˆå¥½çš„ç†è´¢è§„åˆ’èƒ½åŠ›ã€‚é€‚åˆé€šè¿‡å¤šç§æ¸ é“è·å¾—æ”¶å…¥ï¼Œå¦‚ä¸»ä¸šåŠ å‰¯ä¸šã€æŠ•èµ„ç†è´¢ç­‰ã€‚'
      wealthText += ' æ‚¨æœ‰å¾ˆå¼ºçš„é€‚åº”èƒ½åŠ›å’Œåº”å˜èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ ¹æ®å¸‚åœºå˜åŒ–è°ƒæ•´æŠ•èµ„ç­–ç•¥ã€‚å»ºè®®ä¿æŒçµæ´»æ€§ï¼Œä¸è¦è¿‡äºä¿å®ˆã€‚'
    } else {
      wealthText = 'æ‚¨çš„è´¢è¿å¹³ç¨³ï¼Œéœ€è¦åˆç†è§„åˆ’ï¼Œé¿å…å†²åŠ¨æ¶ˆè´¹ã€‚é€‚åˆç¨³å¥çš„ç†è´¢æ–¹å¼ï¼Œå¦‚å®šæœŸå­˜æ¬¾ã€åŸºé‡‘å®šæŠ•ç­‰ã€‚'
      wealthText += ' æ‚¨æœ‰å¾ˆå¥½çš„å­¦ä¹ èƒ½åŠ›ï¼Œå¯ä»¥é€šè¿‡å­¦ä¹ ç†è´¢çŸ¥è¯†æ¥æå‡è‡ªå·±çš„è´¢å¯Œç®¡ç†èƒ½åŠ›ã€‚å»ºè®®åˆ¶å®šè¯¦ç»†çš„è´¢åŠ¡è®¡åˆ’ã€‚'
    }
    
    // æ ¹æ®åç¥è°ƒæ•´
    if (shishen.some(s => s.includes('æ­£è´¢'))) {
      wealthText += ' å‘½ä¸­æœ‰æ­£è´¢ï¼Œæ‚¨æœ‰ç¨³å®šçš„æ”¶å…¥æ¥æºï¼Œèƒ½å¤Ÿé€šè¿‡åŠªåŠ›å·¥ä½œè·å¾—è´¢å¯Œã€‚å»ºè®®ä¿æŒç¨³å®šçš„å·¥ä½œï¼ŒåŒæ—¶åšå¥½ç†è´¢è§„åˆ’ã€‚'
    }
    if (shishen.some(s => s.includes('åè´¢'))) {
      wealthText += ' å‘½ä¸­æœ‰åè´¢ï¼Œæ‚¨æœ‰å¾ˆå¥½çš„æŠ•èµ„å’Œç†è´¢èƒ½åŠ›ï¼Œèƒ½å¤Ÿé€šè¿‡æŠ•èµ„ã€å‰¯ä¸šç­‰æ–¹å¼è·å¾—é¢å¤–æ”¶å…¥ã€‚å»ºè®®æŠŠæ¡æŠ•èµ„æœºä¼šï¼Œä½†è¦æ³¨æ„é£é™©æ§åˆ¶ã€‚'
    }
    if (shishen.some(s => s.includes('æ¯”è‚©') || s.includes('åŠ«è´¢'))) {
      wealthText += ' å‘½ä¸­æœ‰æ¯”åŠ«ï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„èµšé’±èƒ½åŠ›ï¼Œä½†èŠ±é’±ä¹Ÿæ¯”è¾ƒå¿«ã€‚å»ºè®®åšå¥½è´¢åŠ¡è§„åˆ’ï¼Œé¿å…è¿‡åº¦æ¶ˆè´¹ï¼Œå­¦ä¼šå‚¨è“„å’ŒæŠ•èµ„ã€‚'
    }
    
    // æ ¹æ®äº”è¡Œå¼ºå¼±è°ƒæ•´
    if (wuxing['é‡‘'] >= 3) {
      wealthText += ' äº”è¡Œä¸­é‡‘è¾ƒæ—ºï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„ç†è´¢èƒ½åŠ›å’Œé£é™©æ§åˆ¶æ„è¯†ï¼Œé€‚åˆä»äº‹é‡‘èã€æŠ•èµ„ç­‰ç›¸å…³å·¥ä½œï¼Œèƒ½å¤Ÿé€šè¿‡ä¸“ä¸šèƒ½åŠ›è·å¾—è´¢å¯Œã€‚'
    }
    if (wuxing['åœŸ'] >= 3) {
      wealthText += ' äº”è¡Œä¸­åœŸè¾ƒæ—ºï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„ç§¯ç´¯è´¢å¯Œçš„èƒ½åŠ›ï¼Œé€‚åˆç¨³å¥æŠ•èµ„ï¼Œå¦‚æˆ¿åœ°äº§ã€åœŸåœ°ç­‰ï¼Œèƒ½å¤Ÿé€šè¿‡é•¿æœŸæŒæœ‰è·å¾—æ”¶ç›Šã€‚'
    }
    
    return wealthText
  }
  
  const wealthText = getWealthAnalysis(maxWuxing, minWuxing, wuxing, shishen)
  
  // å¥åº·åˆ†æï¼ˆæ›´ä¸°å¯Œï¼‰
  const getHealthAnalysis = (minWuxing: string, wuxing: { [key: string]: number }, dayWuxing: string): string => {
    let healthText = ''
    
    // åŸºç¡€å¥åº·åˆ†æ
    if (minWuxing === 'æ°´') {
      healthText = 'æ‚¨éœ€è¦æ³¨æ„è‚¾è„ã€æ³Œå°¿ç³»ç»Ÿã€ç”Ÿæ®–ç³»ç»Ÿçš„å¥åº·ã€‚å»ºè®®å¤šè¡¥å……æ°´åˆ†ï¼Œä¿æŒè§„å¾‹çš„ä½œæ¯ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯ã€‚'
      healthText += ' å¹³æ—¶å¯ä»¥å¤šåƒä¸€äº›é»‘è‰²é£Ÿç‰©ï¼Œå¦‚é»‘è±†ã€é»‘èŠéº»ç­‰ï¼Œæœ‰åŠ©äºè¡¥è‚¾ã€‚é¿å…ç†¬å¤œå’Œè¿‡åº¦é¥®é…’ï¼Œä¿æŒå……è¶³çš„ç¡çœ ã€‚'
    } else if (minWuxing === 'ç«') {
      healthText = 'æ‚¨éœ€è¦æ³¨æ„å¿ƒè„ã€è¡€æ¶²å¾ªç¯ã€å¿ƒè¡€ç®¡ç³»ç»Ÿçš„å¥åº·ã€‚å»ºè®®ä¿æŒæƒ…ç»ªç¨³å®šï¼Œé¿å…è¿‡åº¦æ¿€åŠ¨å’Œå‹åŠ›ã€‚'
      healthText += ' å¹³æ—¶å¯ä»¥å¤šåšä¸€äº›æœ‰æ°§è¿åŠ¨ï¼Œå¦‚æ•£æ­¥ã€æ…¢è·‘ç­‰ï¼Œæœ‰åŠ©äºä¿ƒè¿›è¡€æ¶²å¾ªç¯ã€‚é¿å…è¿‡åº¦åŠ³ç´¯å’Œæƒ…ç»ªæ³¢åŠ¨ï¼Œä¿æŒå¿ƒæƒ…æ„‰æ‚¦ã€‚'
    } else if (minWuxing === 'æœ¨') {
      healthText = 'æ‚¨éœ€è¦æ³¨æ„è‚èƒ†ã€ç¥ç»ç³»ç»Ÿã€çœ¼ç›çš„å¥åº·ã€‚å»ºè®®ä¿æŒè§„å¾‹ä½œæ¯ï¼Œé¿å…ç†¬å¤œå’Œè¿‡åº¦ç”¨çœ¼ã€‚'
      healthText += ' å¹³æ—¶å¯ä»¥å¤šåƒä¸€äº›ç»¿è‰²é£Ÿç‰©ï¼Œå¦‚é’èœã€æ°´æœç­‰ï¼Œæœ‰åŠ©äºæŠ¤è‚ã€‚é¿å…è¿‡åº¦é¥®é…’å’Œæƒ…ç»ªæ³¢åŠ¨ï¼Œä¿æŒå¿ƒæƒ…èˆ’ç•…ã€‚'
    } else if (minWuxing === 'é‡‘') {
      healthText = 'æ‚¨éœ€è¦æ³¨æ„å‘¼å¸ç³»ç»Ÿã€çš®è‚¤ã€å¤§è‚ çš„å¥åº·ã€‚å»ºè®®é¿å…è¿‡åº¦åŠ³ç´¯ï¼Œä¿æŒå……è¶³çš„ä¼‘æ¯ï¼Œæ³¨æ„ä¿æš–ã€‚'
      healthText += ' å¹³æ—¶å¯ä»¥å¤šåƒä¸€äº›ç™½è‰²é£Ÿç‰©ï¼Œå¦‚ç™½èåœã€æ¢¨ç­‰ï¼Œæœ‰åŠ©äºæ¶¦è‚ºã€‚é¿å…å¸çƒŸå’Œæ¥è§¦æœ‰å®³æ°”ä½“ï¼Œä¿æŒç©ºæ°”æµé€šã€‚'
    } else {
      healthText = 'æ‚¨çš„èº«ä½“å¥åº·çŠ¶å†µæ€»ä½“è‰¯å¥½ï¼Œä½†éœ€è¦æ³¨æ„è„¾èƒƒã€æ¶ˆåŒ–ç³»ç»Ÿçš„å¥åº·ã€‚å»ºè®®ä¿æŒè§„å¾‹çš„é¥®é£Ÿå’Œä½œæ¯ã€‚'
      healthText += ' å¹³æ—¶å¯ä»¥å¤šåƒä¸€äº›é»„è‰²é£Ÿç‰©ï¼Œå¦‚å°ç±³ã€å—ç“œç­‰ï¼Œæœ‰åŠ©äºå¥è„¾ã€‚é¿å…æš´é¥®æš´é£Ÿå’Œè¿‡åº¦åŠ³ç´¯ï¼Œä¿æŒé€‚åº¦è¿åŠ¨ã€‚'
    }
    
    // æ ¹æ®æ—¥ä¸»äº”è¡Œè°ƒæ•´
    if (dayWuxing === 'æœ¨' && wuxing['æœ¨'] < 2) {
      healthText += ' æ‚¨çš„æ—¥ä¸»ä¸ºæœ¨ä½†æœ¨è¾ƒå¼±ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„è‚èƒ†å¥åº·ï¼Œå»ºè®®å¤šè¿›è¡Œæˆ·å¤–æ´»åŠ¨ï¼Œæ¥è§¦è‡ªç„¶ï¼Œæœ‰åŠ©äºæå‡æœ¨çš„èƒ½é‡ã€‚'
    }
    if (dayWuxing === 'ç«' && wuxing['ç«'] < 2) {
      healthText += ' æ‚¨çš„æ—¥ä¸»ä¸ºç«ä½†ç«è¾ƒå¼±ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å¿ƒè„å¥åº·ï¼Œå»ºè®®å¤šè¿›è¡Œé€‚åº¦çš„è¿åŠ¨ï¼Œä¿æŒå¿ƒæƒ…æ„‰æ‚¦ï¼Œæœ‰åŠ©äºæå‡ç«çš„èƒ½é‡ã€‚'
    }
    if (dayWuxing === 'åœŸ' && wuxing['åœŸ'] < 2) {
      healthText += ' æ‚¨çš„æ—¥ä¸»ä¸ºåœŸä½†åœŸè¾ƒå¼±ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„è„¾èƒƒå¥åº·ï¼Œå»ºè®®ä¿æŒè§„å¾‹çš„é¥®é£Ÿï¼Œé¿å…æš´é¥®æš´é£Ÿï¼Œæœ‰åŠ©äºæå‡åœŸçš„èƒ½é‡ã€‚'
    }
    if (dayWuxing === 'é‡‘' && wuxing['é‡‘'] < 2) {
      healthText += ' æ‚¨çš„æ—¥ä¸»ä¸ºé‡‘ä½†é‡‘è¾ƒå¼±ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„å‘¼å¸ç³»ç»Ÿå¥åº·ï¼Œå»ºè®®å¤šè¿›è¡Œæ·±å‘¼å¸ç»ƒä¹ ï¼Œä¿æŒç©ºæ°”æµé€šï¼Œæœ‰åŠ©äºæå‡é‡‘çš„èƒ½é‡ã€‚'
    }
    if (dayWuxing === 'æ°´' && wuxing['æ°´'] < 2) {
      healthText += ' æ‚¨çš„æ—¥ä¸»ä¸ºæ°´ä½†æ°´è¾ƒå¼±ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„è‚¾è„å¥åº·ï¼Œå»ºè®®å¤šè¡¥å……æ°´åˆ†ï¼Œä¿æŒè§„å¾‹çš„ä½œæ¯ï¼Œæœ‰åŠ©äºæå‡æ°´çš„èƒ½é‡ã€‚'
    }
    
    return healthText
  }
  
  const healthText = getHealthAnalysis(minWuxing, wuxing, dayWuxing)
  
  // æ„Ÿæƒ…åˆ†æï¼ˆæ›´ä¸°å¯Œï¼‰
  const getRelationshipAnalysis = (shishen: string[], _dayWuxing: string, wuxing: { [key: string]: number }): string => {
    let relationshipText = ''
    
    // åŸºç¡€æ„Ÿæƒ…åˆ†æ
    if (shishen.some(s => s.includes('æ­£å®˜'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿è¾ƒå¥½ï¼Œå®¹æ˜“é‡åˆ°åˆé€‚çš„ä¼´ä¾£ï¼Œå©šå§»ç¨³å®šå¹¸ç¦ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è´£ä»»æ„Ÿå’Œå®¶åº­è§‚å¿µï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°ç»è¥æ„Ÿæƒ…å’Œå©šå§»ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…è®¤çœŸè´Ÿè´£ï¼Œä¸ä¼šè½»æ˜“æ”¾å¼ƒï¼Œèƒ½å¤Ÿä¸ä¼´ä¾£å…±åŒé¢å¯¹ç”Ÿæ´»ä¸­çš„å›°éš¾å’ŒæŒ‘æˆ˜ã€‚å»ºè®®ä¿æŒæ²Ÿé€šå’Œç†è§£ï¼Œå…±åŒæˆé•¿ã€‚'
    } else if (shishen.some(s => s.includes('æ­£è´¢'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿å¹³ç¨³ï¼Œèƒ½å¤Ÿé‡åˆ°åˆé€‚çš„ä¼´ä¾£ï¼Œå©šå§»ç”Ÿæ´»å’Œè°ç¨³å®šã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ç†è´¢èƒ½åŠ›ï¼Œèƒ½å¤Ÿä¸ºå®¶åº­æä¾›ç¨³å®šçš„ç»æµåŸºç¡€ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…å¿ è¯šä¸“ä¸€ï¼Œé‡è§†å®¶åº­å’Œäº²æƒ…ï¼Œèƒ½å¤Ÿä¸ä¼´ä¾£å…±åŒè§„åˆ’æœªæ¥ã€‚å»ºè®®ä¿æŒæµªæ¼«å’ŒæƒŠå–œï¼Œè®©æ„Ÿæƒ…ä¿æŒæ–°é²œæ„Ÿã€‚'
    } else if (shishen.some(s => s.includes('ä¸ƒæ€') || s.includes('åå®˜'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…ç»å†è¾ƒä¸ºä¸°å¯Œï¼Œå®¹æ˜“é‡åˆ°ä¸åŒç±»å‹çš„å¼‚æ€§ï¼Œä½†éœ€è¦æ‰¾åˆ°çœŸæ­£é€‚åˆè‡ªå·±çš„äººã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ä¸ªäººé­…åŠ›ï¼Œä½†æœ‰æ—¶è¿‡äºå¼ºåŠ¿ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œä¸å®¹æ˜“æ»¡è¶³ï¼Œéœ€è¦å­¦ä¼šåŒ…å®¹å’Œç†è§£ã€‚å»ºè®®ä¿æŒçœŸè¯šå’Œæ²Ÿé€šï¼Œæ‰¾åˆ°èƒ½å¤Ÿç›¸äº’ç†è§£å’Œæ”¯æŒçš„ä¼´ä¾£ã€‚'
    } else if (shishen.some(s => s.includes('åè´¢'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿èµ·ä¼è¾ƒå¤§ï¼Œå®¹æ˜“é‡åˆ°æ¡ƒèŠ±ï¼Œä½†éœ€è¦è°¨æ…é€‰æ‹©ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„ä¸ªäººé­…åŠ›ï¼Œä½†æœ‰æ—¶è¿‡äºèŠ±å¿ƒï¼Œéœ€è¦å­¦ä¼šä¸“ä¸€ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œå–œæ¬¢æ–°é²œæ„Ÿå’Œåˆºæ¿€ï¼Œä½†éœ€è¦æ‰¾åˆ°èƒ½å¤ŸçœŸæ­£ç†è§£å’Œæ”¯æŒè‡ªå·±çš„äººã€‚å»ºè®®ä¿æŒçœŸè¯šå’Œè´£ä»»æ„Ÿã€‚'
    } else if (shishen.some(s => s.includes('é£Ÿç¥'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿è¾ƒå¥½ï¼Œå®¹æ˜“é‡åˆ°æ¸©æŸ”ä½“è´´çš„ä¼´ä¾£ï¼Œå©šå§»ç”Ÿæ´»å’Œè°ç¾æ»¡ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è‰ºæœ¯æ°”è´¨å’Œæµªæ¼«æƒ…æ€€ï¼Œèƒ½å¤Ÿä¸ºæ„Ÿæƒ…å¢æ·»è‰²å½©ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…é‡è§†ç²¾ç¥å±‚é¢çš„äº¤æµï¼Œå–œæ¬¢ä¸ä¼´ä¾£åˆ†äº«ç”Ÿæ´»ä¸­çš„ç¾å¥½ã€‚å»ºè®®ä¿æŒæ²Ÿé€šå’Œç†è§£ï¼Œå…±åŒåˆ›é€ ç¾å¥½çš„å›å¿†ã€‚'
    } else if (shishen.some(s => s.includes('ä¼¤å®˜'))) {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿è¾ƒä¸ºå¤æ‚ï¼Œå®¹æ˜“é‡åˆ°æ€§æ ¼å·®å¼‚è¾ƒå¤§çš„ä¼´ä¾£ï¼Œéœ€è¦å­¦ä¼šåŒ…å®¹å’Œç†è§£ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è¡¨è¾¾èƒ½åŠ›å’Œä¸ªäººé­…åŠ›ï¼Œä½†æœ‰æ—¶è¿‡äºæŒ‘å‰”ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œä¸å®¹æ˜“æ»¡è¶³ï¼Œéœ€è¦å­¦ä¼šæ¬£èµå’Œçæƒœã€‚å»ºè®®ä¿æŒçœŸè¯šå’Œæ²Ÿé€šï¼Œæ‰¾åˆ°èƒ½å¤Ÿç›¸äº’ç†è§£å’Œæ”¯æŒçš„ä¼´ä¾£ã€‚'
    } else {
      relationshipText = 'æ‚¨çš„æ„Ÿæƒ…è¿åŠ¿å¹³ç¨³ï¼Œéœ€è¦ä¸»åŠ¨æŠŠæ¡æœºä¼šï¼ŒçœŸè¯šå¯¹å¾…æ„Ÿæƒ…ã€‚æ‚¨æœ‰å¾ˆå¼ºçš„è´£ä»»æ„Ÿå’Œå®¶åº­è§‚å¿µï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°ç»è¥æ„Ÿæƒ…å’Œå©šå§»ã€‚'
      relationshipText += ' æ‚¨å¯¹æ„Ÿæƒ…è®¤çœŸè´Ÿè´£ï¼Œä¸ä¼šè½»æ˜“æ”¾å¼ƒï¼Œèƒ½å¤Ÿä¸ä¼´ä¾£å…±åŒé¢å¯¹ç”Ÿæ´»ä¸­çš„å›°éš¾å’ŒæŒ‘æˆ˜ã€‚å»ºè®®ä¿æŒæ²Ÿé€šå’Œç†è§£ï¼Œå…±åŒæˆé•¿ã€‚'
    }
    
    // æ ¹æ®äº”è¡Œè°ƒæ•´
    if (wuxing['ç«'] >= 3) {
      relationshipText += ' äº”è¡Œä¸­ç«è¾ƒæ—ºï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„çƒ­æƒ…å’Œé­…åŠ›ï¼Œå®¹æ˜“å¸å¼•å¼‚æ€§ï¼Œä½†éœ€è¦æ³¨æ„æ§åˆ¶æƒ…ç»ªï¼Œé¿å…è¿‡äºæ€¥èºå’Œå†²åŠ¨ã€‚'
    }
    if (wuxing['æ°´'] >= 3) {
      relationshipText += ' äº”è¡Œä¸­æ°´è¾ƒæ—ºï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„æ„Ÿæƒ…å’ŒåŒç†å¿ƒï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°ç†è§£å’Œæ”¯æŒä¼´ä¾£ï¼Œä½†éœ€è¦æ³¨æ„æƒ…ç»ªç®¡ç†ï¼Œé¿å…è¿‡äºæ•æ„Ÿã€‚'
    }
    if (wuxing['é‡‘'] >= 3) {
      relationshipText += ' äº”è¡Œä¸­é‡‘è¾ƒæ—ºï¼Œæ‚¨å¯¹æ„Ÿæƒ…æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œä¸å®¹æ˜“æ»¡è¶³ï¼Œéœ€è¦å­¦ä¼šåŒ…å®¹å’Œç†è§£ï¼Œæ‰¾åˆ°çœŸæ­£é€‚åˆè‡ªå·±çš„äººã€‚'
    }
    if (wuxing['æœ¨'] >= 3) {
      relationshipText += ' äº”è¡Œä¸­æœ¨è¾ƒæ—ºï¼Œæ‚¨æœ‰å¾ˆå¼ºçš„è´£ä»»æ„Ÿå’Œå®¶åº­è§‚å¿µï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°ç»è¥æ„Ÿæƒ…å’Œå©šå§»ï¼Œä½†éœ€è¦æ³¨æ„ä¸è¦è¿‡äºå›ºæ‰§ã€‚'
    }
    if (wuxing['åœŸ'] >= 3) {
      relationshipText += ' äº”è¡Œä¸­åœŸè¾ƒæ—ºï¼Œæ‚¨å¯¹æ„Ÿæƒ…å¿ è¯šä¸“ä¸€ï¼Œé‡è§†å®¶åº­å’Œäº²æƒ…ï¼Œèƒ½å¤Ÿä¸ºå®¶åº­æä¾›ç¨³å®šçš„åŸºç¡€ï¼Œä½†éœ€è¦æ³¨æ„ä¸è¦è¿‡äºä¿å®ˆã€‚'
    }
    
    return relationshipText
  }
  
  const relationshipText = getRelationshipAnalysis(shishen, dayWuxing, wuxing)
  
  // æ€»ç»“
  const summary = `æ‚¨çš„æ—¥ä¸»ä¸º${dayGan}(${dayWuxing})ï¼Œäº”è¡Œä¸­${maxWuxing}è¾ƒæ—ºï¼Œ${minWuxing}è¾ƒå¼±ã€‚æ•´ä½“æ¥è¯´ï¼Œæ‚¨${personality}ï¼Œåœ¨${career}æ–¹é¢æœ‰ä¼˜åŠ¿ã€‚è´¢è¿æ–¹é¢${wealthText}ã€‚å¥åº·æ–¹é¢${healthText}ã€‚æ„Ÿæƒ…æ–¹é¢${relationshipText}ã€‚`
  
  return {
    personality,
    career,
    wealth: wealthText,
    health: healthText,
    relationship: relationshipText,
    summary
  }
}

// å†œå†æ•°æ®è¡¨ï¼ˆ1900-2100å¹´ï¼Œå…±201å¹´ï¼‰
const lunarInfo = [
  0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
  0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
  0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
  0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
  0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
  0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5b0, 0x14573, 0x052b0, 0x0a9a8, 0x0e950, 0x06aa0,
  0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
  0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b6a0, 0x195a6,
  0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
  0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
  0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
  0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
  0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
  0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
  0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0,
  0x14b63, 0x09370, 0x049f8, 0x04970, 0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0,
  0x0a2e0, 0x0d2e3, 0x0c960, 0x0d557, 0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4,
  0x052d0, 0x0a9b8, 0x0a950, 0x0b4a0, 0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0,
  0x0b273, 0x06930, 0x07337, 0x06aa0, 0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d160,
  0x0e968, 0x0d520, 0x0daa0, 0x16aa6, 0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252,
  0x0d520, 0x0f968, 0x05580, 0x0b540, 0x0b6a0, 0x195a6, 0x095b0, 0x049b0, 0x0a974, 0x0a4b0,
  0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570, 0x04af5, 0x04970, 0x064b0, 0x074a3,
  0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0, 0x0c960, 0x0d954, 0x0d4a0, 0x0da50,
  0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5, 0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50,
  0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930, 0x07954, 0x06aa0, 0x0ad50, 0x05b52,
  0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530, 0x05aa0, 0x076a3, 0x096d0, 0x04bd7,
  0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45, 0x0b5a0, 0x056d0, 0x055b2, 0x049b0,
  0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0, 0x14b63, 0x09370, 0x049f8, 0x04970,
  0x064b0, 0x168a6, 0x0ea50, 0x06b20, 0x1a6c4, 0x0aae0, 0x0a2e0, 0x0d2e3, 0x0c960, 0x0d557,
  0x0d4a0, 0x0da50, 0x05d55, 0x056a0, 0x0a6d0, 0x055d4, 0x052d0, 0x0a9b8, 0x0a950, 0x0b4a0,
  0x0b6a6, 0x0ad50, 0x055a0, 0x0aba4, 0x0a5b0, 0x052b0, 0x0b273, 0x06930, 0x07337, 0x06aa0,
  0x0ad50, 0x14b55, 0x04b60, 0x0a570, 0x054e4, 0x0d160, 0x0e968, 0x0d520, 0x0daa0, 0x16aa6,
  0x056d0, 0x04ae0, 0x0a9d4, 0x0a2d0, 0x0d150, 0x0f252, 0x0d520, 0x0f968, 0x05580, 0x0b540
]

// è·å–é—°æœˆæœˆä»½
function getLeapMonth(year: number): number {
  const yearIndex = year - 1900
  if (yearIndex < 0 || yearIndex >= lunarInfo.length) return 0
  const info = lunarInfo[yearIndex]
  return info & 0xf
}

// è·å–é—°æœˆå¤©æ•°
function getLeapDays(year: number): number {
  const leapMonth = getLeapMonth(year)
  if (leapMonth === 0) return 0
  const yearIndex = year - 1900
  if (yearIndex < 0 || yearIndex >= lunarInfo.length) return 0
  const info = lunarInfo[yearIndex]
  return (info & 0x10000) ? 30 : 29
}

// è·å–å†œå†å¹´æ€»å¤©æ•°
function getLunarYearDays(year: number): number {
  const yearIndex = year - 1900
  if (yearIndex < 0 || yearIndex >= lunarInfo.length) return 0
  const info = lunarInfo[yearIndex]
  let total = 0
  for (let i = 0x8000; i > 0x8; i >>= 1) {
    total += (info & i) ? 30 : 29
  }
  return total + getLeapDays(year)
}

// è·å–å†œå†æœˆå¤©æ•°
function getLunarMonthDays(year: number, month: number): number {
  const yearIndex = year - 1900
  if (yearIndex < 0 || yearIndex >= lunarInfo.length) return 0
  const info = lunarInfo[yearIndex]
  
  // å¤„ç†é—°æœˆï¼šmonth > 12 è¡¨ç¤ºé—°æŸæœˆ
  const isLeapMonth = month > 12
  const baseMonth = isLeapMonth ? month - 12 : month
  
  if (baseMonth < 1 || baseMonth > 12) return 0
  
  // å¦‚æœæ˜¯é—°æœˆï¼Œè¿”å›é—°æœˆå¤©æ•°
  if (isLeapMonth) {
    return (info & 0x10000) ? 30 : 29
  }
  
  // æ™®é€šæœˆä»½
  return (info & (0x10000 >> baseMonth)) ? 30 : 29
}

// å†œå†è½¬é˜³å†
function lunarToSolar(lunarYear: number, lunarMonth: number, lunarDay: number): Date | null {
  if (lunarYear < 1900 || lunarYear > 2100) {
    return null
  }
  
  const yearIndex = lunarYear - 1900
  if (yearIndex < 0 || yearIndex >= lunarInfo.length) {
    return null
  }
  
  const leapMonth = getLeapMonth(lunarYear)
  const isLeapMonth = lunarMonth > 12
  const baseMonth = isLeapMonth ? lunarMonth - 12 : lunarMonth

  if (baseMonth < 1 || baseMonth > 12) {
    return null
  }
  if (isLeapMonth && baseMonth !== leapMonth) {
    return null
  }
  
  const monthDays = getLunarMonthDays(lunarYear, lunarMonth)
  if (lunarDay < 1 || lunarDay > monthDays) {
    return null
  }
  
  let totalDays = 0
  const baseDate = new Date(1900, 0, 31)
  
  for (let y = 1900; y < lunarYear; y++) {
    totalDays += getLunarYearDays(y)
  }
  
  for (let m = 1; m < baseMonth; m++) {
    totalDays += getLunarMonthDays(lunarYear, m)
    if (leapMonth > 0 && m === leapMonth) {
      totalDays += getLunarMonthDays(lunarYear, leapMonth + 12)
    }
  }
  if (isLeapMonth) totalDays += getLunarMonthDays(lunarYear, baseMonth)
  
  totalDays += lunarDay - 1
  
  const solarDate = new Date(baseDate)
  solarDate.setDate(solarDate.getDate() + totalDays)
  
  return solarDate
}

function BaziFortune({ onBack }: BaziFortuneProps) {
  const [calendarType, setCalendarType] = useState<'solar' | 'lunar'>('solar')
  const [birthDate, setBirthDate] = useState('')
  const [lunarYear, setLunarYear] = useState('')
  const [lunarMonth, setLunarMonth] = useState('')
  const [lunarDay, setLunarDay] = useState('')
  const [isLunarLeapMonth, setIsLunarLeapMonth] = useState(false)
  const [birthTime, setBirthTime] = useState('å­')
  const [result, setResult] = useState<{
    bazi: string[]
    wuxing: { [key: string]: number }
    shishen: string[]
    interpretation: any
  } | null>(null)

  const shichenOptions = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
  const shichenNames: { [key: string]: string } = {
    'å­': 'å­æ—¶(23:00-01:00)', 'ä¸‘': 'ä¸‘æ—¶(01:00-03:00)', 'å¯…': 'å¯…æ—¶(03:00-05:00)',
    'å¯': 'å¯æ—¶(05:00-07:00)', 'è¾°': 'è¾°æ—¶(07:00-09:00)', 'å·³': 'å·³æ—¶(09:00-11:00)',
    'åˆ': 'åˆæ—¶(11:00-13:00)', 'æœª': 'æœªæ—¶(13:00-15:00)', 'ç”³': 'ç”³æ—¶(15:00-17:00)',
    'é…‰': 'é…‰æ—¶(17:00-19:00)', 'æˆŒ': 'æˆŒæ—¶(19:00-21:00)', 'äº¥': 'äº¥æ—¶(21:00-23:00)'
  }

  const calculateFortune = () => {
    let date: Date | null = null

    if (calendarType === 'solar') {
      if (!birthDate) {
        alert('è¯·è¾“å…¥å‡ºç”Ÿæ—¥æœŸ')
        return
      }
      date = new Date(birthDate)
      if (isNaN(date.getTime())) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸ')
        return
      }
    } else {
      // å†œå†
      if (!lunarYear || !lunarMonth || !lunarDay) {
        alert('è¯·å®Œæ•´è¾“å…¥å†œå†æ—¥æœŸ')
        return
      }

      const year = parseInt(lunarYear)
      const month = parseInt(lunarMonth)
      const day = parseInt(lunarDay)

      if (isNaN(year) || isNaN(month) || isNaN(day)) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¥æœŸ')
        return
      }

      if (year < 1900 || year > 2100) {
        alert('è¯·è¾“å…¥1900-2100å¹´ä¹‹é—´çš„æ—¥æœŸ')
        return
      }

      const lunarMonthParam = isLunarLeapMonth ? month + 12 : month
      const solarDate = lunarToSolar(year, lunarMonthParam, day)
      
      if (!solarDate) {
        alert('å†œå†æ—¥æœŸè½¬æ¢å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼š\n1. æ—¥æœŸè¶…å‡ºæ”¯æŒèŒƒå›´ï¼ˆ1900-2100å¹´ï¼‰\n2. è¾“å…¥çš„æ—¥æœŸæ— æ•ˆ\n3. è¯¥å¹´æ²¡æœ‰å¯¹åº”çš„å†œå†æœˆä»½\n\nè¯·æ£€æŸ¥è¾“å…¥çš„æ—¥æœŸæ˜¯å¦æ­£ç¡®ã€‚')
        return
      }
      
      date = solarDate
    }

    if (!date) {
      alert('æ—¥æœŸè®¡ç®—å¤±è´¥')
      return
    }

    // è®¡ç®—å…«å­—
    const yearPillar = calculateYearPillar(date)
    const monthPillar = calculateMonthPillar(date, yearPillar)
    const dayPillar = calculateDayPillar(date)
    const hourPillar = calculateHourPillar(dayPillar, birthTime)

    if (!hourPillar) {
      alert('è¯·é€‰æ‹©å‡ºç”Ÿæ—¶è¾°')
      return
    }

    const bazi = [yearPillar, monthPillar, dayPillar, hourPillar]
    const wuxing = analyzeWuxing(bazi)
    const shishen = analyzeShishen(bazi)
    const interpretation = interpretBazi(bazi, wuxing, shishen)

    setResult({
      bazi,
      wuxing,
      shishen,
      interpretation
    })
  }

  return (
    <div className="bazi-fortune-container">
      <button className="back-button" onClick={onBack}>
        â† è¿”å›
      </button>

      <div className="bazi-header">
        <h1>ğŸ”® å…«å­—ç®—å‘½</h1>
        <p className="subtitle">é€šè¿‡ç”Ÿè¾°å…«å­—åˆ†ææ‚¨çš„æ€§æ ¼ã€äº‹ä¸šã€è´¢è¿ã€å¥åº·å’Œæ„Ÿæƒ…</p>
      </div>

      <div className="bazi-input-section">
        <div className="input-group">
          <label>å†æ³•ç±»å‹</label>
          <div className="calendar-type-toggle">
            <button
              className={`toggle-btn ${calendarType === 'solar' ? 'active' : ''}`}
              onClick={() => setCalendarType('solar')}
            >
              é˜³å†
            </button>
            <button
              className={`toggle-btn ${calendarType === 'lunar' ? 'active' : ''}`}
              onClick={() => setCalendarType('lunar')}
            >
              å†œå†
            </button>
          </div>
        </div>

        {calendarType === 'solar' ? (
          <div className="input-group">
            <label>å‡ºç”Ÿæ—¥æœŸï¼ˆé˜³å†ï¼‰</label>
            <input
              type="date"
              value={birthDate}
              onChange={(e) => setBirthDate(e.target.value)}
              max={new Date().toISOString().split('T')[0]}
            />
          </div>
        ) : (
          <>
            <div className="input-group">
              <label>å‡ºç”Ÿæ—¥æœŸï¼ˆå†œå†ï¼‰</label>
              <div className="lunar-inputs">
                <input
                  type="number"
                  placeholder="å¹´"
                  value={lunarYear}
                  onChange={(e) => setLunarYear(e.target.value)}
                  min="1900"
                  max="2100"
                />
                <span className="input-separator">å¹´</span>
                <input
                  type="number"
                  placeholder="æœˆ"
                  value={lunarMonth}
                  onChange={(e) => setLunarMonth(e.target.value)}
                  min="1"
                  max="12"
                />
                <span className="input-separator">æœˆ</span>
                <input
                  type="number"
                  placeholder="æ—¥"
                  value={lunarDay}
                  onChange={(e) => setLunarDay(e.target.value)}
                  min="1"
                  max="30"
                />
                <span className="input-separator">æ—¥</span>
              </div>
            </div>
            <div className="input-group">
              <label className="leap-checkbox-label">
                <input
                  type="checkbox"
                  checked={isLunarLeapMonth}
                  onChange={(e) => setIsLunarLeapMonth(e.target.checked)}
                />
                <span>é—°æœˆ</span>
              </label>
            </div>
          </>
        )}

        <div className="input-group">
          <label>å‡ºç”Ÿæ—¶è¾°</label>
          <select
            value={birthTime}
            onChange={(e) => setBirthTime(e.target.value)}
          >
            {shichenOptions.map(shichen => (
              <option key={shichen} value={shichen}>
                {shichenNames[shichen]}
              </option>
            ))}
          </select>
        </div>

        <button className="calculate-btn" onClick={calculateFortune}>
          å¼€å§‹ç®—å‘½
        </button>
      </div>

      {result && (
        <div className="bazi-result-section">
          <div className="bazi-pillars">
            <h3>æ‚¨çš„å…«å­—</h3>
            <div className="pillars-display">
              <div className="pillar">
                <div className="pillar-label">å¹´æŸ±</div>
                <div className="pillar-value">{result.bazi[0]}</div>
              </div>
              <div className="pillar">
                <div className="pillar-label">æœˆæŸ±</div>
                <div className="pillar-value">{result.bazi[1]}</div>
              </div>
              <div className="pillar">
                <div className="pillar-label">æ—¥æŸ±</div>
                <div className="pillar-value">{result.bazi[2]}</div>
              </div>
              <div className="pillar">
                <div className="pillar-label">æ—¶æŸ±</div>
                <div className="pillar-value">{result.bazi[3]}</div>
              </div>
            </div>
          </div>

          <div className="wuxing-analysis">
            <h3>äº”è¡Œåˆ†æ</h3>
            <div className="wuxing-bars">
              {Object.entries(result.wuxing).map(([wuxing, count]) => (
                <div key={wuxing} className="wuxing-item">
                  <div className="wuxing-label">{wuxing}</div>
                  <div className="wuxing-bar">
                    <div
                      className="wuxing-fill"
                      style={{ width: `${(count / 8) * 100}%` }}
                    />
                  </div>
                  <div className="wuxing-count">{count}</div>
                </div>
              ))}
            </div>
          </div>

          {result.shishen.length > 0 && (
            <div className="shishen-analysis">
              <h3>åç¥åˆ†æ</h3>
              <div className="shishen-tags">
                {result.shishen.map((s, index) => (
                  <span key={index} className="shishen-tag">{s}</span>
                ))}
              </div>
            </div>
          )}

          <div className="interpretation-section">
            <h3>å‘½ç†è§£è¯»</h3>
            <div className="interpretation-cards">
              <div className="interpretation-card">
                <h4>æ€§æ ¼ç‰¹ç‚¹</h4>
                <p>{result.interpretation.personality}</p>
              </div>
              <div className="interpretation-card">
                <h4>äº‹ä¸šå‘å±•</h4>
                <p>{result.interpretation.career}</p>
              </div>
              <div className="interpretation-card">
                <h4>è´¢è¿åˆ†æ</h4>
                <p>{result.interpretation.wealth}</p>
              </div>
              <div className="interpretation-card">
                <h4>å¥åº·çŠ¶å†µ</h4>
                <p>{result.interpretation.health}</p>
              </div>
              <div className="interpretation-card">
                <h4>æ„Ÿæƒ…å©šå§»</h4>
                <p>{result.interpretation.relationship}</p>
              </div>
            </div>
            <div className="summary-card">
              <h4>ç»¼åˆæ€»ç»“</h4>
              <p>{result.interpretation.summary}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bazi-tips">
        <h4>æ¸©é¦¨æç¤º</h4>
        <ul>
          <li>å…«å­—ç®—å‘½ä»…ä¾›å‚è€ƒï¼Œä¸åº”è¿‡åº¦ä¾èµ–</li>
          <li>å‘½è¿æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ï¼ŒåŠªåŠ›å’Œé€‰æ‹©åŒæ ·é‡è¦</li>
          <li>ä¼ ç»Ÿå‘½ç†ä¸ç°ä»£ç§‘å­¦ç»“åˆï¼Œç†æ€§çœ‹å¾…</li>
          <li>å¦‚æœ‰ç–‘é—®ï¼Œå»ºè®®å’¨è¯¢ä¸“ä¸šå‘½ç†å¸ˆ</li>
        </ul>
      </div>
    </div>
  )
}

export default BaziFortune

